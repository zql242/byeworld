<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chanel & Rolex Â· æ¯’è—¥æ£‹å±€</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
        }
        .game {
            max-width: 820px;
            width: 100%;
            background: #ffffff;
            border-radius: 32px;
            padding: 24px 24px 28px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08), 0 0 0 2px #e9d4b0 inset;
            border: 1px solid #d4b17c;
            position: relative;
        }

        .title {
            text-align: center;
            margin-bottom: 20px;
        }
        .title h1 {
            font-size: 3.2rem;
            font-weight: 600;
            color: #3a4a55;
            letter-spacing: 2px;
            line-height: 1.2;
        }
        .title h1 span {
            color: #d4a017;
            margin: 0 8px;
        }

        .player-tags {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 8px;
            margin-bottom: 4px;
        }
        .player-tags .tag {
            font-size: 1.9rem;
            font-weight: 700;
            color: #2b4b5c;
            background: #f0ebe2;
            padding: 4px 24px;
            border-radius: 40px;
            border: 2px solid #dbb875;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .player-tags .tag.right {
            color: #2b4b5c;
            border-color: #dbb875;
        }

        .lives-row {
            display: flex;
            justify-content: space-between;
            padding: 0 20px 12px;
            font-size: 1.8rem;
        }
        .chanel-love, .rolex-love { 
            color: #d4a017; 
        }

        .boards {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            margin: 8px 0 16px;
        }
        .board {
            background: #f8f4ed;
            border-radius: 28px;
            padding: 24px 20px 20px;
            width: 300px;
            border: 3px solid #cfaa6b;
            box-shadow: 0 6px 0 #e0c9a5;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .board .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
            justify-items: center;
            align-items: center;
            width: 100%;
        }
        .cell {
            width: 80px;
            height: 80px;
            background: #d9e2e8;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.4rem;
            font-weight: 600;
            color: #1d3b4a;
            box-shadow: 0 4px 0 #b2c1cc;
            border: 2px solid #9ab3c4;
            cursor: pointer;
            transition: 0.05s;
            margin: 0 auto;
        }
        .cell:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #b2c1cc;
        }
        
        .cell.disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        
        /* é™·é˜±æ¨™è¨˜ - ç´…è‰²ï¼Œç–ŠåŠ æ•¸å­—é¡¯ç¤ºæ•¸é‡ */
        .cell.trap-set {
            background: #ffcdcd !important;
            border-color: #ff6b6b !important;
            position: relative;
        }
        
        .cell.trap-set::after {
            content: attr(data-count);
            position: absolute;
            top: 2px;
            right: 2px;
            background: #ff4444;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 2px;
        }
        
        /* äººé¡é¸æ‰‹éŒ¶ï¼ˆå³é‚Šï¼‰ */
        #rolexGrid .cell {
            background: #d9e2e8;
            cursor: pointer;
            opacity: 1 !important;
            color: #1d3b4a;
        }
        
        .board-footer {
            font-size: 0.95rem;
            color: #7c6846;
            background: #ede5d7;
            display: inline-block;
            padding: 4px 16px;
            border-radius: 30px;
            border: 1px solid #c5a56b;
            margin-top: 4px;
            text-align: center;
        }

        .popup-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff3e0;
            border: 3px solid #d4a017;
            border-radius: 40px;
            padding: 12px 24px;
            box-shadow: 0 6px 0 #b27d2e, 0 10px 20px rgba(0,0,0,0.15);
            z-index: 100;
            text-align: center;
            min-width: 200px;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }
        
        .popup-message.show {
            opacity: 1;
        }
        
        .popup-message .popup-emoji {
            font-size: 2.5rem;
            margin-bottom: 2px;
        }
        
        .popup-message .popup-text {
            font-size: 1.4rem;
            font-weight: 700;
            color: #3a4a55;
            margin-bottom: 2px;
        }
        
        .popup-message .popup-sub {
            font-size: 1rem;
            color: #7c6846;
        }

        .message {
            background: #f0ebe2;
            border-radius: 40px;
            padding: 12px 20px;
            margin: 12px 0 16px;
            border: 2px solid #dbb875;
            color: #3d4f5c;
            font-size: 1.2rem;
            text-align: center;
            min-height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .actions {
            display: flex;
            gap: 16px;
            justify-content: center;
        }
        .btn {
            background: #e6dccb;
            border: none;
            color: #2f4b5c;
            font-size: 1.5rem;
            font-weight: 600;
            padding: 10px 28px;
            border-radius: 50px;
            box-shadow: 0 5px 0 #cbb99b;
            cursor: pointer;
            transition: 0.05s;
            border: 2px solid #dbb06b;
            min-width: 170px;
        }
        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 1px 0 #cbb99b;
        }
        .btn.reset {
            background: #ddd3c4;
            border-color: #b294d1;
            color: #3a4055;
        }

        .stage {
            text-align: center;
            margin-top: 12px;
            font-size: 1rem;
            background: #ede5d7;
            display: inline-block;
            padding: 4px 24px;
            border-radius: 30px;
            color: #7c6846;
            border: 1px solid #c5a56b;
        }
    </style>
</head>
<body>
<div class="game">
    <div class="popup-message" id="popupMessage">
        <div class="popup-emoji" id="popupEmoji">ğŸ’£</div>
        <div class="popup-text" id="popupText">ç‚¸å½ˆï¼</div>
        <div class="popup-sub" id="popupSub">æå¤± 1ğŸ’°</div>
    </div>

    <div class="title">
        <h1>Chanel <span>&</span> Rolex</h1>
    </div>

    <div class="player-tags">
        <span class="tag">ğŸ›ï¸ Chanel (é›»è…¦)</span>
        <span class="tag right">âŒšï¸ Rolex (ä½ )</span>
    </div>

    <div class="lives-row">
        <span class="chanel-love" id="chanelHearts">ğŸ’°ğŸ’°ğŸ’°</span>
        <span class="rolex-love" id="rolexHearts">ğŸ’°ğŸ’°ğŸ’°</span>
    </div>

    <div class="boards">
        <div class="board">
            <div class="grid" id="chanelGrid"></div>
            <div class="board-footer">ğŸ›ï¸ Chanel çš„åŒ…åŒ… (é›»è…¦å…ˆé¸)</div>
        </div>
        <div class="board">
            <div class="grid" id="rolexGrid"></div>
            <div class="board-footer">âŒšï¸ ä½ çš„æ‰‹éŒ¶ (ä½ å¾Œé¸)</div>
        </div>
    </div>

    <div class="message" id="gameMessage">æº–å‚™éšæ®µ Â· é»ã€Œä¸‹ä¸€æ­¥ã€</div>

    <div class="actions">
        <button class="btn" id="nextBtn">â© ä¸‹ä¸€æ­¥</button>
        <button class="btn reset" id="resetBtn">ğŸ”„ é‡ä¾†</button>
    </div>

    <div class="stage" id="phaseDisplay">âš™ï¸ éšæ®µ 1/3</div>
</div>

<script>
    (function() {
        const POS = ['A1','A2','A3','B1','B2','B3','C1','C2','C3'];
        const INIT = 3;

        const BAG_EMOJI = 'ğŸ›ï¸';
        const WATCH_EMOJI = 'âŒšï¸';

        const BAG_MAP = {};
        const WATCH_MAP = {};
        POS.forEach((pos) => {
            BAG_MAP[pos] = BAG_EMOJI;
            WATCH_MAP[pos] = WATCH_EMOJI;
        });

        const P1 = 'computerPoison';  // é›»è…¦åœ¨ä½ çš„æ‰‹éŒ¶æ”¾ç‚¸å½ˆ
        const P2 = 'humanPoison';     // ä½ åœ¨é›»è…¦çš„åŒ…åŒ…æ”¾ç‚¸å½ˆ
        const P3 = 'battle';          // å°æ±º

        let stage = P1;
        let chanelMoney = INIT, rolexMoney = INIT;
        let trapOnRolexWatches = new Set();  // é›»è…¦åœ¨ä½ æ‰‹éŒ¶æ”¾çš„ç‚¸å½ˆ (å³é‚Š)
        let trapOnChanelBags = new Map();    // ä½ åœ¨é›»è…¦åŒ…åŒ…æ”¾çš„ç‚¸å½ˆ (å·¦é‚Š) - ç”¨ Map å­˜æ•¸é‡
        let chanelBagsUsed = new Set();      // é›»è…¦å·²é¸çš„åŒ…åŒ… (å·¦é‚Š)
        let rolexWatchesUsed = new Set();    // ä½ å·²é¸çš„æ‰‹éŒ¶ (å³é‚Š)
        let computerTurn = true;              // true = é›»è…¦å…ˆé¸å·¦é‚ŠåŒ…åŒ…, false = ä½ é¸æ‰‹éŒ¶
        let gameOver = false;

        const chanelGrid = document.getElementById('chanelGrid');
        const rolexGrid = document.getElementById('rolexGrid');
        const msg = document.getElementById('gameMessage');
        const phaseEl = document.getElementById('phaseDisplay');
        const chanelMoneySpan = document.getElementById('chanelHearts');
        const rolexMoneySpan = document.getElementById('rolexHearts');
        const nextBtn = document.getElementById('nextBtn');
        const resetBtn = document.getElementById('resetBtn');
        
        const popup = document.getElementById('popupMessage');
        const popupEmoji = document.getElementById('popupEmoji');
        const popupText = document.getElementById('popupText');
        const popupSub = document.getElementById('popupSub');

        function showPopup(emoji, text, sub) {
            popupEmoji.innerText = emoji;
            popupText.innerText = text;
            popupSub.innerText = sub;
            popup.classList.add('show');
            
            setTimeout(() => {
                popup.classList.remove('show');
            }, 1200);
        }

        function updateMoney() {
            chanelMoneySpan.innerText = 'ğŸ’°'.repeat(chanelMoney);
            rolexMoneySpan.innerText = 'ğŸ’°'.repeat(rolexMoney);
        }

        // è¨ˆç®—ç¸½ç‚¸å½ˆæ•¸é‡
        function getTotalBombs() {
            let total = 0;
            for (let count of trapOnChanelBags.values()) {
                total += count;
            }
            return total;
        }

        function draw() {
            // å·¦é‚Šï¼šChanel çš„åŒ…åŒ… (é›»è…¦å…ˆé¸)
            chanelGrid.innerHTML = '';
            POS.forEach(p => {
                let cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.pos = p;
                cell.dataset.board = 'chanel';
                
                let mainEmoji = BAG_MAP[p];
                
                // å¸ƒç½®éšæ®µï¼šé¡¯ç¤ºä½ åœ¨é›»è…¦åŒ…åŒ…æ”¾çš„é™·é˜± (ç´…è‰²)
                if (stage === P2) {
                    let bombCount = trapOnChanelBags.get(p) || 0;
                    if (bombCount > 0) {
                        cell.classList.add('trap-set');
                        cell.dataset.count = bombCount;
                    } else {
                        cell.classList.remove('trap-set');
                        delete cell.dataset.count;
                    }
                }
                
                // æˆ°é¬¥éšæ®µé¡¯ç¤ºçµæœ
                if (stage === P3) {
                    cell.classList.remove('trap-set');
                    delete cell.dataset.count;
                    
                    // å¦‚æœé€™å€‹æ ¼å­æœ‰ç‚¸å½ˆä¸”è¢«é›»è…¦é¸ä¸­
                    if (chanelBagsUsed.has(p)) {
                        let bombCount = trapOnChanelBags.get(p) || 0;
                        if (bombCount > 0) {
                            mainEmoji = 'ğŸ’£';
                            // å¦‚æœæœ‰å¤šå€‹ç‚¸å½ˆï¼Œé¡¯ç¤ºæ•¸é‡
                            if (bombCount > 1) {
                                cell.dataset.count = bombCount;
                            }
                        } else {
                            mainEmoji = 'âœ…';
                        }
                    }
                }
                
                cell.textContent = mainEmoji;
                
                // æˆ°é¬¥éšæ®µä¹‹å¾Œä¸å¯é»
                if (stage === P3) {
                    cell.style.pointerEvents = 'none';
                } else {
                    cell.style.pointerEvents = 'auto';
                }
                
                chanelGrid.appendChild(cell);
            });

            // å³é‚Šï¼šRolex çš„æ‰‹éŒ¶ (ä½ å¾Œé¸)
            rolexGrid.innerHTML = '';
            POS.forEach(p => {
                let cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.pos = p;
                cell.dataset.board = 'rolex';
                
                let mainEmoji = WATCH_MAP[p];
                if (stage === P3 && rolexWatchesUsed.has(p) && trapOnRolexWatches.has(p)) {
                    mainEmoji = 'ğŸ’£';
                } else if (stage === P3 && rolexWatchesUsed.has(p)) {
                    mainEmoji = 'âœ…';
                }
                
                cell.textContent = mainEmoji;
                
                if (stage === P3 && rolexWatchesUsed.has(p)) cell.classList.add('disabled');
                cell.style.background = '';
                rolexGrid.appendChild(cell);
            });
        }

        function resetAll() {
            chanelMoney = INIT; rolexMoney = INIT;
            trapOnRolexWatches.clear(); 
            trapOnChanelBags.clear();
            chanelBagsUsed.clear(); 
            rolexWatchesUsed.clear();
            gameOver = false; 
            computerTurn = true;  // é›»è…¦å…ˆæ‰‹
            stage = P1;
            updateMoney(); draw(); updateMessage();
        }

        function updateMessage() {
            if (gameOver) return;
            if (stage === P1) {
                msg.innerHTML = 'ğŸ¤– é›»è…¦ Chanel æ­£åœ¨ä½ çš„æ‰‹éŒ¶æ”¾ç‚¸å½ˆ Â· é»ã€Œä¸‹ä¸€æ­¥ã€';
                phaseEl.innerText = 'âš™ï¸ éšæ®µ 1/3ï¼šé›»è…¦æ”¾ç‚¸å½ˆ';
            } else if (stage === P2) {
                let total = getTotalBombs();
                msg.innerHTML = `ğŸ›ï¸ ä½ åœ¨é›»è…¦çš„åŒ…åŒ…æ”¾ç‚¸å½ˆ Â· é»å·¦é‚Š ğŸ›ï¸ é¸ç‚¸å½ˆ (å¯é‡è¤‡) ç›®å‰ ${total}/3`;
                phaseEl.innerText = 'âš™ï¸ éšæ®µ 2/3ï¼šä½ æ”¾ç‚¸å½ˆ';
            } else if (stage === P3) {
                if (computerTurn) {
                    msg.innerHTML = 'ğŸ›ï¸ é›»è…¦å›åˆ Â· Chanel å…ˆé¸åŒ…åŒ… (å¯èƒ½æœƒè¸©åˆ°ä½ çš„ç‚¸å½ˆ)';
                } else {
                    msg.innerHTML = 'âŒšï¸ ä½ çš„å›åˆ Â· é»å³é‚Š âŒšï¸ é¸æ‰‹éŒ¶ (å°å¿ƒé›»è…¦çš„ç‚¸å½ˆ)';
                }
                phaseEl.innerText = 'âš”ï¸ éšæ®µ 3/3ï¼šå°æ±º';
            }
        }

        function computerSetTrap() {
            let shuffled = [...POS];
            for (let i = shuffled.length - 1; i > 0; i--) {
                let j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            trapOnRolexWatches = new Set(shuffled.slice(0, 3));
            console.log('é›»è…¦åœ¨ä½ æ‰‹éŒ¶æ”¾çš„ç‚¸å½ˆ:', trapOnRolexWatches);
        }

        function checkWin() {
            if (chanelMoney <= 0) {
                gameOver = true;
                msg.innerHTML = 'ğŸ† ä½  (Rolex) å‹åˆ©ï¼ é›»è…¦ç ´ç”¢äº† ğŸ’¸';
                phaseEl.innerText = 'ğŸ‰ éŠæˆ²çµæŸ';
                return true;
            } else if (rolexMoney <= 0) {
                gameOver = true;
                msg.innerHTML = 'ğŸ† é›»è…¦ (Chanel) å‹åˆ©ï¼ ä½ ç ´ç”¢äº† ğŸ’¸';
                phaseEl.innerText = 'ğŸ’€ éŠæˆ²çµæŸ';
                return true;
            }
            return false;
        }

        // é›»è…¦å›åˆï¼šé¸å·¦é‚Š Chanel çš„åŒ…åŒ… (é›»è…¦å…ˆæ‰‹)
        function computerMove() {
            if (gameOver || stage !== P3 || !computerTurn) return;

            let available = POS.filter(p => !chanelBagsUsed.has(p));
            if (available.length === 0) return;

            let pick = available[Math.floor(Math.random() * available.length)];
            chanelBagsUsed.add(pick);

            let bombCount = trapOnChanelBags.get(pick) || 0;
            let totalDamage = 0;
            
            // è¨ˆç®—ç‚¸å½ˆå‚·å®³
            if (bombCount > 0) {
                totalDamage = bombCount;
                chanelMoney -= bombCount;
                if (chanelMoney < 0) chanelMoney = 0;
            }
            
            if (bombCount > 0) {
                let bombText = bombCount > 1 ? `ğŸ’£ğŸ’£ ${bombCount}å€‹ç‚¸å½ˆï¼` : 'ğŸ’£ ç‚¸å½ˆï¼';
                showPopup('ğŸ’£', bombText, `æå¤± ${bombCount}ğŸ’°`);
                msg.innerHTML = `ğŸ›ï¸ é›»è…¦é¸äº† ğŸ›ï¸ Â· ${bombText}æå¤± ${bombCount}ğŸ’°<br>ğŸ’° Chanel é‚„å‰© ${chanelMoney} æ¬¡æ©Ÿæœƒ`;
            } else {
                showPopup('âœ…', 'å¹³å®‰éé—œ', '');
                msg.innerHTML = `ğŸ›ï¸ é›»è…¦é¸äº† ğŸ›ï¸ Â· âœ… å¹³å®‰éé—œ<br>ğŸ’° Chanel é‚„å‰© ${chanelMoney} æ¬¡æ©Ÿæœƒ`;
            }

            draw();
            updateMoney();

            if (checkWin()) { draw(); return; }

            computerTurn = false;  // æ›ä½ é¸æ‰‹éŒ¶
            updateMessage();
        }

        function handleBoardClick(e) {
            let cell = e.target.closest('.cell');
            if (!cell) return;
            if (gameOver) { 
                msg.innerHTML = 'â›” éŠæˆ²çµæŸ Â· æŒ‰é‡ä¾†';
                return;
            }

            let board = cell.dataset.board;
            let pos = cell.dataset.pos;

            if (stage === P1) {
                msg.innerHTML = 'â³ å…ˆé»ã€Œä¸‹ä¸€æ­¥ã€è®“é›»è…¦æ”¾ç‚¸å½ˆ';
                return;
            }

            // éšæ®µ2: ä½ åœ¨é›»è…¦çš„åŒ…åŒ…æ”¾ç‚¸å½ˆ (é»å·¦é‚Š)
            if (stage === P2) {
                if (board !== 'chanel') {
                    msg.innerHTML = 'âŒ è«‹é»å·¦é‚Š (Chanel çš„åŒ…åŒ…) æ”¾ç‚¸å½ˆ';
                    return;
                }
                
                let total = getTotalBombs();
                if (total >= 3) {
                    msg.innerHTML = 'âœ… å·²é¸æ»¿ 3 å€‹ç‚¸å½ˆ Â· é»ã€Œä¸‹ä¸€æ­¥ã€';
                    return;
                }
                
                // å¢åŠ ç‚¸å½ˆæ•¸é‡ (å¯é‡è¤‡)
                let currentCount = trapOnChanelBags.get(pos) || 0;
                trapOnChanelBags.set(pos, currentCount + 1);
                
                // æ›´æ–°é¡¯ç¤º
                cell.classList.add('trap-set');
                cell.dataset.count = currentCount + 1;
                
                let newTotal = getTotalBombs();
                msg.innerHTML = `ğŸ’£ ç‚¸å½ˆè¨­ç½® (${newTotal}/3) çµ¦é›»è…¦`;
                if (newTotal === 3) {
                    msg.innerHTML = 'ğŸ¯ ç‚¸å½ˆå®Œæˆ Â· é»ã€Œä¸‹ä¸€æ­¥ã€å°æ±º';
                }
                return;
            }

            // éšæ®µ3: å°æ±º
            if (stage === P3) {
                // ä½ çš„å›åˆï¼šé¸å³é‚Šçš„æ‰‹éŒ¶ (ä½ å¾Œé¸)
                if (!computerTurn) {
                    if (board !== 'rolex') {
                        msg.innerHTML = 'âŒ è«‹é»å³é‚Š (ä½ çš„æ‰‹éŒ¶)';
                        return;
                    }
                    if (rolexWatchesUsed.has(pos)) {
                        msg.innerHTML = 'âŒ› å·²ç¶“é¸éé€™å€‹æ‰‹éŒ¶äº†';
                        return;
                    }

                    rolexWatchesUsed.add(pos);
                    let trapped = trapOnRolexWatches.has(pos);

                    if (trapped) {
                        rolexMoney--;
                        showPopup('ğŸ’£', 'ç‚¸å½ˆï¼', 'æå¤± 1ğŸ’°');
                        msg.innerHTML = `âŒšï¸ ä½ é¸äº† âŒšï¸ Â· ğŸ’£ ç‚¸å½ˆï¼æå¤± 1ğŸ’°<br>ğŸ’° ä½ é‚„å‰© ${rolexMoney} æ¬¡æ©Ÿæœƒ`;
                    } else {
                        showPopup('âœ…', 'å¹³å®‰éé—œ', '');
                        msg.innerHTML = `âŒšï¸ ä½ é¸äº† âŒšï¸ Â· âœ… å¹³å®‰éé—œ<br>ğŸ’° ä½ é‚„å‰© ${rolexMoney} æ¬¡æ©Ÿæœƒ`;
                    }

                    draw();
                    updateMoney();

                    if (checkWin()) { draw(); return; }

                    // æ›é›»è…¦é¸åŒ…åŒ…
                    computerTurn = true;
                    updateMessage();

                    setTimeout(() => {
                        if (!gameOver && stage === P3 && computerTurn) computerMove();
                    }, 600);
                } 
                // é›»è…¦å›åˆï¼šä½ ä¸èƒ½é»
                else {
                    msg.innerHTML = 'ğŸ›ï¸ é›»è…¦å›åˆä¸­ Â· è«‹ç¨å€™...';
                }
            }
        }

        function nextStep() {
            if (gameOver) { resetAll(); return; }

            if (stage === P1) {
                computerSetTrap();
                stage = P2;
                draw();
                updateMessage();
                msg.innerHTML = 'ğŸ™ˆ æ›ä½ åœ¨é›»è…¦åŒ…åŒ…æ”¾ç‚¸å½ˆ Â· é»å·¦é‚Š ğŸ›ï¸ é¸ç‚¸å½ˆ (å¯é‡è¤‡)';
            }
            else if (stage === P2) {
                let total = getTotalBombs();
                if (total !== 3) {
                    msg.innerHTML = `âš ï¸ éœ€è¦å‰›å¥½ 3 å€‹ç‚¸å½ˆ (ç›®å‰ ${total}/3)`;
                    return;
                }
                stage = P3;
                computerTurn = true;  // é›»è…¦å…ˆæ‰‹
                draw();
                updateMessage();
                
                // é›»è…¦å…ˆé–‹å§‹
                setTimeout(() => {
                    if (!gameOver && stage === P3 && computerTurn) computerMove();
                }, 600);
            }
            else if (stage === P3) {
                msg.innerHTML = computerTurn ? 'ğŸ›ï¸ é›»è…¦å›åˆ' : 'âŒšï¸ ä½ çš„å›åˆ (é»å³é‚Šæ‰‹éŒ¶)';
            }
        }

        document.querySelector('.boards').addEventListener('click', handleBoardClick);
        nextBtn.addEventListener('click', nextStep);
        resetBtn.addEventListener('click', resetAll);

        resetAll();
    })();
</script>
</body>
</html>