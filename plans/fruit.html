<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ‡å§æ°´æœ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #333;
        }
        
        .header {
            width: 100%;
            max-width: 900px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }
        
        .game-title {
            color: #ff6b8b;
            font-size: 48px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .main-container {
            display: flex;
            width: 100%;
            max-width: 900px;
            gap: 20px;
        }
        
        .game-area {
            flex: 3;
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            background-color: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid #eaeaea;
        }
        
        #gameCanvas {
            width: 100%;
            height: 500px;
            display: block;
            background-color: #ffffff;
        }
        
        .side-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .score-container {
            background-color: #ffffff;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 2px solid #eaeaea;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .score-title {
            color: #666;
            font-size: 16px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .score {
            color: #ff6b8b;
            font-size: 48px;
            font-weight: bold;
        }
        
        .combo-container {
            background-color: #ffffff;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 2px solid #eaeaea;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .combo-title {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .combo {
            color: #5a9cff;
            font-size: 32px;
            font-weight: bold;
        }
        
        .controls-container {
            background-color: #ffffff;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 2px solid #eaeaea;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-top: auto;
        }
        
        .start-btn {
            background: linear-gradient(to bottom, #ff6b8b, #ff4d6d);
            color: white;
            border: none;
            padding: 15px 25px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(255, 107, 139, 0.2);
        }
        
        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 107, 139, 0.3);
        }
        
        .start-btn:active {
            transform: translateY(1px);
        }
        
        .footer {
            width: 100%;
            max-width: 900px;
            margin-top: 20px;
            background-color: #ffffff;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #eaeaea;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .rules-title {
            color: #333;
            font-size: 20px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            color: #ff6b8b;
        }
        
        .rules-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 15px;
        }
        
        .rule-item {
            flex: 1;
            min-width: 180px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #5a9cff;
        }
        
        .rule-item h4 {
            color: #5a9cff;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .rule-item p {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            border-radius: 15px;
        }
        
        .game-over h1 {
            color: #ff4d6d;
            font-size: 48px;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .final-score {
            color: #ff6b8b;
            font-size: 60px;
            font-weight: bold;
            margin-bottom: 30px;
        }
        
        .restart-btn {
            background: linear-gradient(to bottom, #5a9cff, #3a7cdf);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(90, 156, 255, 0.2);
        }
        
        .game-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: #666;
            font-size: 14px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #eaeaea;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .fruit-count {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #666;
            font-size: 16px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #eaeaea;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .time-container {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #666;
            font-size: 16px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #eaeaea;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .missed-counter {
            position: absolute;
            top: 80px;
            left: 20px;
            color: #ff6b8b;
            font-size: 14px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid #ff6b8b;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            font-weight: bold;
        }
        
        .score1000-badge {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #ff6b8b, #ff4d6d);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            display: none;
            z-index: 5;
            box-shadow: 0 5px 20px rgba(255, 107, 139, 0.5);
            animation: glow 1s infinite alternate;
            white-space: nowrap;
        }
        
        .score1000-timer {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.95);
            color: #ff6b8b;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            display: none;
            z-index: 5;
            border: 2px solid #ff6b8b;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }
        
        .start-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 10;
        }
        
        .start-game-btn {
            background: linear-gradient(to bottom, #ff6b8b, #ff4d6d);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(255, 107, 139, 0.3);
        }
        
        .start-game-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 107, 139, 0.4);
        }
        
        .start-game-btn:active {
            transform: translateY(1px);
        }
        
        .cut-effect {
            position: absolute;
            pointer-events: none;
            z-index: 5;
        }
        
        /* æŠ€èƒ½é¸æ“‡ç•Œé¢ */
        .skill-selection {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 15;
            border-radius: 15px;
        }
        
        .skill-title {
            color: #ff6b8b;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .skills-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            max-width: 90%;
            margin-bottom: 25px;
        }
        
        .skill-card {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 15px;
            width: 150px;
            text-align: center;
            border: 2px solid #eaeaea;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .skill-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border-color: #5a9cff;
        }
        
        .skill-card.selected {
            border-color: #ff6b8b;
            background-color: rgba(255, 107, 139, 0.05);
            transform: scale(1.05);
        }
        
        .skill-icon {
            font-size: 30px;
            margin-bottom: 10px;
            height: 35px;
        }
        
        .skill-name {
            color: #333;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .skill-desc {
            color: #666;
            font-size: 12px;
            line-height: 1.3;
        }
        
        .select-skill-btn {
            background: linear-gradient(to bottom, #5a9cff, #3a7cdf);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(90, 156, 255, 0.2);
        }
        
        .active-skills {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 5;
        }
        
        .active-skill {
            background-color: rgba(90, 156, 255, 0.9);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        
        .active-skill .skill-charge {
            background-color: white;
            color: #5a9cff;
            border-radius: 15px;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .bomb-warning {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            z-index: 10;
            display: none;
            animation: pulse 1s infinite;
        }
        
        .bomb-immunity-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(90, 156, 255, 0.9);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            z-index: 10;
            display: none;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        @keyframes glow {
            0% { box-shadow: 0 5px 20px rgba(255, 107, 139, 0.5); }
            100% { box-shadow: 0 5px 30px rgba(255, 107, 139, 0.8); }
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .game-title {
                font-size: 36px;
            }
            
            .score {
                font-size: 36px;
            }
            
            .combo {
                font-size: 24px;
            }
            
            .skills-container {
                flex-direction: column;
                align-items: center;
            }
            
            .skill-card {
                width: 80%;
            }
            
            .score1000-badge {
                font-size: 14px;
                padding: 8px 16px;
                white-space: normal;
                width: 90%;
            }
            
            .score1000-timer {
                top: 100px;
                font-size: 14px;
                white-space: normal;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="game-title">åˆ‡å§æ°´æœ</h1>
    </div>
    
    <div class="main-container">
        <div class="game-area">
            <canvas id="gameCanvas"></canvas>
            
            <div class="time-container" id="timeContainer">æ™‚é–“: 60ç§’</div>
            <div class="fruit-count" id="fruitCount">æ°´æœ: 0</div>
            <div class="missed-counter" id="missedCounter">æ‰å‡º: 0</div>
            
            <div class="score1000-badge" id="score1000Badge">ğŸ‰ 1000åˆ†é”æˆï¼æ°´æœåŠ é€Ÿ10ç§’ï¼ ğŸ‰</div>
            <div class="score1000-timer" id="score1000Timer">â±ï¸ åŠ é€Ÿå‰©é¤˜: 10ç§’</div>
            
            <div class="start-container">
                <button class="start-game-btn" id="startGameBtn">é–‹å§‹éŠæˆ²</button>
            </div>
            
            <div class="active-skills" id="activeSkills"></div>
            
            <div class="bomb-warning" id="bombWarning">âš ï¸ ç‚¸å½ˆï¼æ‰£1000åˆ†ï¼ âš ï¸</div>
            <div class="bomb-immunity-effect" id="bombImmunityEffect">ğŸ›¡ï¸ ç‚¸å½ˆå…ç–«ï¼å‰©é¤˜æ¬¡æ•¸ ğŸ›¡ï¸</div>
            
            <!-- æŠ€èƒ½é¸æ“‡ç•Œé¢ - åªé¡¯ç¤º3å€‹éš¨æ©ŸæŠ€èƒ½ -->
            <div class="skill-selection" id="skillSelection">
                <h2 class="skill-title">é¸æ“‡ä¸€å€‹æŠ€èƒ½é–‹å§‹éŠæˆ²</h2>
                <div class="skills-container" id="skillsContainer">
                    <!-- åªé¡¯ç¤º3å€‹éš¨æ©ŸæŠ€èƒ½å¡ç‰‡ -->
                </div>
                <button class="select-skill-btn" id="selectSkillBtn">é–‹å§‹éŠæˆ²</button>
            </div>
            
            <div class="game-over" id="gameOverScreen">
                <h1 id="gameOverTitle">éŠæˆ²çµæŸ</h1>
                <div class="final-score" id="finalScore">0</div>
                <button class="restart-btn" id="restartBtn">é‡æ–°é–‹å§‹</button>
            </div>
        </div>
        
        <div class="side-panel">
            <div class="score-container">
                <div class="score-title">åˆ†æ•¸</div>
                <div class="score" id="score">0</div>
            </div>
            
            <div class="combo-container">
                <div class="combo-title">é€£æ“Š</div>
                <div class="combo" id="combo">x1</div>
            </div>
            
            <div class="controls-container">
                <h3>éŠæˆ²èªªæ˜</h3>
                <p style="margin-top: 10px; color: #666; font-size: 14px; line-height: 1.5;">
                    1. æ¯å€‹æ°´æœ+10åˆ†<br>
                    2. ç‚¸å½ˆæ‰£1000åˆ† (åˆ†æ•¸â‰¥60åˆ†å‡ºç¾)<br>
                    3. é€£æ“Šå®šç¾©ï¼šæ²’æœ‰æ°´æœæ‰å‡º<br>
                    4. ç‚¸å½ˆå…ç–«æŠ€èƒ½å¯æ“‹3æ¬¡<br>
                    5. 1000åˆ†çå‹µï¼š10ç§’åŠ é€Ÿæ¨¡å¼
                </p>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <h3 class="rules-title">éŠæˆ²è¦å‰‡</h3>
        <div class="rules-list">
            <div class="rule-item">
                <h4>è¨ˆåˆ†è¦å‰‡</h4>
                <p>åˆ‡ä¸­ä¸€å€‹æ°´æœåŠ 10åˆ†ï¼ŒéŒ¯éä¸€å€‹æ°´æœæ‰£5åˆ†ã€‚åˆ†æ•¸è®Šç‚ºè² æ•¸æ™‚éŠæˆ²ç«‹å³çµæŸã€‚</p>
            </div>
            <div class="rule-item">
                <h4>é€£æ“Šç³»çµ±</h4>
                <p>åªè¦æ²’æœ‰æ°´æœæ‰å‡ºè¢å¹•ï¼ˆæœªåˆ‡å‰²è€Œæ‰è½ï¼‰ï¼Œé€£æ“Šå°±æœƒæŒçºŒç´¯ç©ã€‚åˆ‡åˆ°ç‚¸å½ˆä¸æœƒä¸­æ–·é€£æ“Šï¼</p>
            </div>
            <div class="rule-item">
                <h4>1000åˆ†çå‹µ</h4>
                <p>ç•¶åˆ†æ•¸é¦–æ¬¡é”åˆ°1000åˆ†æ™‚ï¼Œæœƒå•Ÿå‹•10ç§’åŠ é€Ÿæ¨¡å¼ï¼æœŸé–“æ¯1ç§’è‡ªå‹•ç”Ÿæˆä¸€å€‹é¡å¤–æ°´æœï¼</p>
            </div>
            <div class="rule-item">
                <h4>ç‚¸å½ˆå…ç–«æŠ€èƒ½</h4>
                <p>é¸æ“‡ç‚¸å½ˆå…ç–«æŠ€èƒ½å¾Œï¼Œå¯ä»¥æŠµæ“‹3æ¬¡ç‚¸å½ˆæ”»æ“Šï¼Œä½¿ç”¨å¾Œæ¬¡æ•¸æœƒæ¸›å°‘ã€‚</p>
            </div>
        </div>
    </div>

    <script>
        // éŠæˆ²è®Šé‡
        let canvas = document.getElementById('gameCanvas');
        let ctx = canvas.getContext('2d');
        let scoreElement = document.getElementById('score');
        let timeElement = document.getElementById('timeContainer');
        let fruitCountElement = document.getElementById('fruitCount');
        let missedCounterElement = document.getElementById('missedCounter');
        let comboElement = document.getElementById('combo');
        let startGameBtn = document.getElementById('startGameBtn');
        let gameOverScreen = document.getElementById('gameOverScreen');
        let gameOverTitle = document.getElementById('gameOverTitle');
        let finalScoreElement = document.getElementById('finalScore');
        let restartBtn = document.getElementById('restartBtn');
        let skillSelection = document.getElementById('skillSelection');
        let skillsContainer = document.getElementById('skillsContainer');
        let selectSkillBtn = document.getElementById('selectSkillBtn');
        let bombWarning = document.getElementById('bombWarning');
        let bombImmunityEffect = document.getElementById('bombImmunityEffect');
        let score1000Badge = document.getElementById('score1000Badge');
        let score1000Timer = document.getElementById('score1000Timer');
        let activeSkillsElement = document.getElementById('activeSkills');
        
        // è¨­ç½®ç•«å¸ƒå¤§å°
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        
        // è¨ˆç®—ç¬¬9æ ¼çš„é«˜åº¦ï¼ˆå°‡ç•«å¸ƒåˆ†ç‚º12æ ¼ï¼‰
        const GRID_ROWS = 12;
        let gridHeight = canvas.height / GRID_ROWS;
        let NINTH_ROW_HEIGHT = gridHeight * 3;
        
        // éŠæˆ²ç‹€æ…‹
        let game = {
            score: 0,
            timeLeft: 60,
            // æ–°å¢ï¼šè¨˜éŒ„å¯¦éš›ç¶“éçš„æ™‚é–“ï¼ˆå¾0é–‹å§‹ï¼Œä¸å—æ™‚é–“å»¶é•·å½±éŸ¿ï¼‰
            elapsedSeconds: 0,
            isRunning: false,
            fruits: [],
            bombs: [],
            cutLines: [],
            combo: 1,
            comboTimeout: null,
            lastCutTime: 0,
            missedFruits: 0,
            fruitInterval: 2000,
            minInterval: 500,
            lastFruitTime: 0,
            lastBombTime: 0,
            bombInterval: 5000,
            bonusFruitInterval: 1000,
            lastBonusFruitTime: 0,
            score1000Reached: false,
            bonusModeActive: false,
            bonusTimeLeft: 0,
            bonusTimerId: null,
            bonusFruitTimerId: null,
            animationId: null,
            timerId: null,
            selectedSkill: null,
            bombImmunityCharges: 0,
            consecutiveCuts: 0,
            maxConsecutiveCuts: 0,
            missedSinceLastCut: false // æ¨™è¨˜æ˜¯å¦æœ‰æ°´æœæ‰å‡ºï¼Œç”¨æ–¼é€£æ“Šåˆ¤æ–·
        };
        
        // æŠ€èƒ½å®šç¾©
        const allSkills = [
            {
                id: 1,
                name: "é›™å€åˆ†æ•¸",
                icon: "ğŸ’°",
                description: "æ¯æ¬¡åˆ‡å‰²æ°´æœç²å¾—é›™å€åˆ†æ•¸",
                effect: "doubleScore"
            },
            {
                id: 2,
                name: "æ™‚é–“å»¶é•·",
                icon: "â±ï¸",
                description: "éŠæˆ²æ™‚é–“å¢åŠ 15ç§’ï¼ˆæ­£å¸¸ç”Ÿæˆæ°´æœï¼‰",
                effect: "extraTime"
            },
            {
                id: 3,
                name: "å¿«é€Ÿé€£æ“Š",
                icon: "âš¡",
                description: "é€£æ“ŠæŒçºŒæ™‚é–“å»¶é•·3ç§’",
                effect: "longerCombo"
            },
            {
                id: 4,
                name: "ç‚¸å½ˆå…ç–«",
                icon: "ğŸ›¡ï¸",
                description: "æŠµæ“‹3æ¬¡ç‚¸å½ˆæ”»æ“Š (ä½¿ç”¨å¾Œæ¬¡æ•¸æ¸›å°‘)",
                effect: "bombImmunity"
            },
            {
                id: 5,
                name: "é€£æ“Šå¤§å¸«",
                icon: "ğŸ‘‘",
                description: "é€£çºŒåˆ‡å‰²8å€‹æ°´æœè§¸ç™¼å…¨å±çˆ†ç‚¸",
                effect: "comboMaster"
            },
            {
                id: 6,
                name: "å¹¸é‹åˆ‡å‰²",
                icon: "ğŸ€",
                description: "æœ‰15%æ©Ÿç‡ç²å¾—3å€åˆ†æ•¸",
                effect: "luckyCut"
            }
        ];
        
        // é®®è±”çš„æ°´æœé¡è‰²
        const colors = [
            '#FF6B8B', // ç²‰ç´…è‰²
            '#5A9CFF', // è—è‰²
            '#4CD964', // ç¶ è‰²
            '#FFCC00', // é»ƒè‰²
            '#AF52DE'  // ç´«è‰²
        ];
        
        // æ°´æœé¡å‹
        const fruitTypes = [
            { 
                name: 'è¥¿ç“œ', 
                color: '#4CD964', 
                points: 10,
                radius: 40
            },
            { 
                name: 'è‰è“', 
                color: '#FF6B8B', 
                points: 10,
                radius: 40
            },
            { 
                name: 'è—è“', 
                color: '#5A9CFF', 
                points: 10,
                radius: 38
            },
            { 
                name: 'æª¸æª¬', 
                color: '#FFCC00', 
                points: 10,
                radius: 42
            },
            { 
                name: 'è‘¡è„', 
                color: '#AF52DE', 
                points: 10,
                radius: 36
            }
        ];
        
        // æ°´æœé¡
        class Fruit {
            constructor(type) {
                this.type = type || fruitTypes[Math.floor(Math.random() * fruitTypes.length)];
                this.radius = this.type.radius + Math.random() * 5;
                this.x = this.radius + Math.random() * (canvas.width - 2 * this.radius);
                this.y = canvas.height + this.radius;
                
                const targetHeight = NINTH_ROW_HEIGHT;
                const gravity = 0.25;
                const requiredSpeed = Math.sqrt(2 * gravity * (canvas.height - targetHeight));
                
                this.speedX = (Math.random() - 0.5) * 3;
                this.speedY = -requiredSpeed;
                this.gravity = gravity;
                this.rotation = 0;
                this.rotationSpeed = (Math.random() - 0.5) * 0.05;
                this.isSliced = false;
                this.slicedTime = 0;
                this.color = this.type.color;
                this.hasScored = false;
            }
            
            update() {
                if (!this.isSliced) {
                    this.x += this.speedX;
                    this.y += this.speedY;
                    this.speedY += this.gravity;
                    this.rotation += this.rotationSpeed;
                    
                    if (this.x < this.radius || this.x > canvas.width - this.radius) {
                        this.speedX *= -0.8;
                        this.x = this.x < this.radius ? this.radius : canvas.width - this.radius;
                    }
                } else {
                    this.slicedTime++;
                }
                
                // å¦‚æœæ°´æœæ‰å‡ºå±å¹•ä¸”æ²’æœ‰è¢«åˆ‡å‰²ï¼Œæ‰£åˆ†ä¸¦æ¨™è¨˜æ‰å‡º
                if (!this.isSliced && this.y > canvas.height + this.radius && !this.hasScored) {
                    this.hasScored = true;
                    
                    game.score -= 5;
                    scoreElement.textContent = game.score;
                    
                    game.missedFruits++;
                    missedCounterElement.textContent = `æ‰å‡º: ${game.missedFruits}`;
                    
                    // åªè¦æœ‰æ°´æœæ‰å‡ºï¼Œå°±æ¨™è¨˜ç‚ºä¸­æ–·é€£æ“Š
                    game.missedSinceLastCut = true;
                    
                    // æª¢æŸ¥æ˜¯å¦è² åˆ†
                    if (game.score < 0 && game.isRunning) {
                        endGame(false);
                    }
                }
                
                return this.y > canvas.height + 100 || this.slicedTime > 30;
            }
            
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                
                if (!this.isSliced) {
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                    ctx.beginPath();
                    ctx.arc(-this.radius * 0.3, -this.radius * 0.3, this.radius * 0.4, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#4CD964';
                    ctx.beginPath();
                    ctx.ellipse(0, -this.radius * 0.8, this.radius * 0.6, this.radius * 0.3, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
                    ctx.shadowBlur = 8;
                    ctx.shadowOffsetY = 3;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    ctx.shadowOffsetY = 0;
                    
                    ctx.fillStyle = '#333';
                    ctx.font = `bold ${Math.floor(this.radius/4)}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(this.type.name, 0, this.radius + 10);
                } else {
                    const sliceAngle = Math.PI / 4;
                    
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(-this.radius * 0.3, 0, this.radius, sliceAngle, Math.PI * 2 - sliceAngle);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.arc(this.radius * 0.3, 0, this.radius, Math.PI + sliceAngle, Math.PI * 3 - sliceAngle);
                    ctx.closePath();
                    ctx.fill();
                    
                    for (let i = 0; i < 8; i++) {
                        const angle = Math.random() * Math.PI * 2;
                        const distance = Math.random() * this.radius * 1.5;
                        const juiceX = Math.cos(angle) * distance;
                        const juiceY = Math.sin(angle) * distance;
                        const juiceSize = Math.random() * 5 + 2;
                        
                        ctx.fillStyle = this.color;
                        ctx.beginPath();
                        ctx.arc(juiceX, juiceY, juiceSize, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
                
                ctx.restore();
            }
            
            slice() {
                if (!this.isSliced && !this.hasScored) {
                    this.isSliced = true;
                    this.hasScored = true;
                    
                    let points = this.type.points * game.combo;
                    
                    if (game.selectedSkill && game.selectedSkill.effect === "doubleScore") {
                        points *= 2;
                    }
                    
                    if (game.selectedSkill && game.selectedSkill.effect === "luckyCut" && Math.random() < 0.15) {
                        points *= 3;
                    }
                    
                    const oldScore = game.score;
                    game.score += points;
                    scoreElement.textContent = game.score;
                    
                    if (oldScore < 1000 && game.score >= 1000 && !game.score1000Reached) {
                        activateScore1000Bonus();
                    }
                    
                    // é€£æ“Šè¨ˆç®— - æ ¹æ“šæ˜¯å¦æ›¾æœ‰æ°´æœæ‰å‡ºä¾†æ±ºå®š
                    const currentTime = Date.now();
                    
                    // å¦‚æœæ²’æœ‰æ°´æœæ‰å‡ºï¼Œæ‰å¢åŠ é€£æ“Š
                    if (!game.missedSinceLastCut && currentTime - game.lastCutTime < 1000) {
                        game.combo = Math.min(10, game.combo + 1);
                        game.consecutiveCuts++;
                        
                        if (game.consecutiveCuts >= 8) {
                            if (game.selectedSkill && game.selectedSkill.effect === "comboMaster") {
                                triggerComboMaster();
                            }
                        }
                    } else {
                        // æœ‰æ°´æœæ‰å‡ºï¼Œé‡ç½®é€£æ“Š
                        game.combo = 1;
                        game.consecutiveCuts = 1;
                        // é‡ç½®æ‰å‡ºæ¨™è¨˜
                        game.missedSinceLastCut = false;
                    }
                    
                    game.lastCutTime = currentTime;
                    
                    comboElement.textContent = `x${game.combo}`;
                    
                    if (game.comboTimeout) clearTimeout(game.comboTimeout);
                    
                    const comboDuration = (game.selectedSkill && game.selectedSkill.effect === "longerCombo") ? 3000 : 1500;
                    game.comboTimeout = setTimeout(() => {
                        game.combo = 1;
                        comboElement.textContent = 'x1';
                        game.consecutiveCuts = 0;
                        // è¨ˆæ™‚å™¨çµæŸæ™‚ä¹Ÿé‡ç½®æ‰å‡ºæ¨™è¨˜
                        game.missedSinceLastCut = false;
                    }, comboDuration);
                    
                    return true;
                }
                return false;
            }
        }
        
        // ç‚¸å½ˆé¡
        class Bomb {
            constructor() {
                this.radius = 35;
                this.x = this.radius + Math.random() * (canvas.width - 2 * this.radius);
                this.y = canvas.height + this.radius;
                
                const targetHeight = NINTH_ROW_HEIGHT;
                const gravity = 0.25;
                const requiredSpeed = Math.sqrt(2 * gravity * (canvas.height - targetHeight));
                
                this.speedX = (Math.random() - 0.5) * 2;
                this.speedY = -requiredSpeed * 0.8;
                this.gravity = gravity;
                this.rotation = 0;
                this.rotationSpeed = (Math.random() - 0.5) * 0.03;
                this.isExploded = false;
                this.explodedTime = 0;
                this.color = '#000000';
            }
            
            update() {
                if (!this.isExploded) {
                    this.x += this.speedX;
                    this.y += this.speedY;
                    this.speedY += this.gravity;
                    this.rotation += this.rotationSpeed;
                    
                    if (this.x < this.radius || this.x > canvas.width - this.radius) {
                        this.speedX *= -0.8;
                        this.x = this.x < this.radius ? this.radius : canvas.width - this.radius;
                    }
                } else {
                    this.explodedTime++;
                }
                
                return this.y > canvas.height + 100 || this.explodedTime > 30;
            }
            
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                
                if (!this.isExploded) {
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(-4, -this.radius - 8, 8, 15);
                    
                    ctx.fillStyle = '#FF0000';
                    ctx.beginPath();
                    ctx.moveTo(0, -this.radius * 0.5);
                    ctx.lineTo(this.radius * 0.4, this.radius * 0.2);
                    ctx.lineTo(-this.radius * 0.4, this.radius * 0.2);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = 'bold 18px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('-1000', 0, 0);
                    
                    ctx.shadowColor = 'rgba(255, 0, 0, 0.5)';
                    ctx.shadowBlur = 15;
                    ctx.shadowOffsetY = 3;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    ctx.shadowOffsetY = 0;
                } else {
                    ctx.fillStyle = '#FF9500';
                    for (let i = 0; i < 12; i++) {
                        const angle = (i * Math.PI * 2) / 12;
                        const distance = this.radius * 2;
                        const sparkX = Math.cos(angle) * distance;
                        const sparkY = Math.sin(angle) * distance;
                        const sparkSize = Math.random() * 10 + 5;
                        
                        ctx.beginPath();
                        ctx.arc(sparkX, sparkY, sparkSize, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    ctx.fillStyle = '#FF0000';
                    ctx.beginPath();
                    ctx.arc(0, 0, this.radius * 1.5, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                ctx.restore();
            }
            
            explode() {
                if (!this.isExploded) {
                    this.isExploded = true;
                    
                    if (game.bombImmunityCharges > 0) {
                        game.bombImmunityCharges--;
                        
                        bombImmunityEffect.innerHTML = `ğŸ›¡ï¸ ç‚¸å½ˆå…ç–«ï¼å‰©é¤˜ ${game.bombImmunityCharges}/3 æ¬¡ ğŸ›¡ï¸`;
                        bombImmunityEffect.style.display = 'block';
                        setTimeout(() => {
                            bombImmunityEffect.style.display = 'none';
                        }, 1500);
                        
                        updateActiveSkillsDisplay();
                        
                        return true;
                    }
                    
                    const oldScore = game.score;
                    game.score -= 1000;
                    scoreElement.textContent = game.score;
                    
                    bombWarning.style.display = 'block';
                    setTimeout(() => {
                        bombWarning.style.display = 'none';
                    }, 2000);
                    
                    if (game.score < 0 && game.isRunning) {
                        endGame(false);
                    }
                    
                    // åˆ‡åˆ°ç‚¸å½ˆä¸å½±éŸ¿é€£æ“Šï¼Œä¹Ÿä¸æ¨™è¨˜æ‰å‡º
                    
                    return true;
                }
                return false;
            }
        }
        
        // è§¸ç™¼1000åˆ†çå‹µ - é™æ™‚10ç§’ï¼Œåªé¡¯ç¤ºä¸Šæ–¹æç¤º
        function activateScore1000Bonus() {
            game.score1000Reached = true;
            game.bonusModeActive = true;
            game.bonusTimeLeft = 10;
            
            // é¡¯ç¤ºä¸Šæ–¹çå‹µæ¨™èªŒ
            score1000Badge.style.display = 'block';
            
            // é¡¯ç¤ºè¨ˆæ™‚å™¨
            score1000Timer.style.display = 'block';
            score1000Timer.innerHTML = `â±ï¸ åŠ é€Ÿå‰©é¤˜: 10ç§’`;
            
            // ç«‹å³ç”Ÿæˆä¸€å€‹çå‹µæ°´æœ
            if (game.isRunning) {
                game.fruits.push(new Fruit());
                fruitCountElement.textContent = `æ°´æœ: ${game.fruits.length}`;
            }
            
            if (game.bonusFruitTimerId) {
                clearInterval(game.bonusFruitTimerId);
            }
            
            game.bonusFruitTimerId = setInterval(() => {
                if (game.isRunning && game.bonusModeActive) {
                    game.fruits.push(new Fruit());
                    fruitCountElement.textContent = `æ°´æœ: ${game.fruits.length}`;
                }
            }, game.bonusFruitInterval);
            
            if (game.bonusTimerId) {
                clearInterval(game.bonusTimerId);
            }
            
            game.bonusTimerId = setInterval(() => {
                if (game.isRunning && game.bonusModeActive) {
                    game.bonusTimeLeft--;
                    score1000Timer.innerHTML = `â±ï¸ åŠ é€Ÿå‰©é¤˜: ${game.bonusTimeLeft}ç§’`;
                    
                    if (game.bonusTimeLeft <= 0) {
                        endScore1000Bonus();
                    }
                }
            }, 1000);
        }
        
        // çµæŸ1000åˆ†çå‹µ
        function endScore1000Bonus() {
            game.bonusModeActive = false;
            
            if (game.bonusTimerId) {
                clearInterval(game.bonusTimerId);
                game.bonusTimerId = null;
            }
            
            if (game.bonusFruitTimerId) {
                clearInterval(game.bonusFruitTimerId);
                game.bonusFruitTimerId = null;
            }
            
            score1000Badge.style.display = 'none';
            score1000Timer.style.display = 'none';
        }
        
        // è§¸ç™¼é€£æ“Šå¤§å¸«æ•ˆæœ
        function triggerComboMaster() {
            for (let i = game.fruits.length - 1; i >= 0; i--) {
                const fruit = game.fruits[i];
                if (!fruit.isSliced) {
                    fruit.isSliced = true;
                    fruit.hasScored = true;
                    const oldScore = game.score;
                    game.score += fruit.type.points * 2;
                    scoreElement.textContent = game.score;
                    
                    if (oldScore < 1000 && game.score >= 1000 && !game.score1000Reached) {
                        activateScore1000Bonus();
                    }
                }
            }
            
            for (let i = 0; i < 20; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                
                game.cutLines.push({
                    x1: x,
                    y1: y,
                    x2: x + Math.random() * 100 - 50,
                    y2: y + Math.random() * 100 - 50,
                    color: '#FF0000',
                    life: 20
                });
            }
            
            game.consecutiveCuts = 0;
        }
        
        // ç¹ªè£½ç¶²æ ¼èƒŒæ™¯
        function drawGridBackground() {
            ctx.strokeStyle = '#f0f0f0';
            ctx.lineWidth = 1;
            
            for (let x = 0; x <= canvas.width; x += canvas.width / 12) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            for (let y = 0; y <= canvas.height; y += canvas.height / 12) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            ctx.fillStyle = 'rgba(255, 107, 139, 0.1)';
            const ninthRowY = canvas.height - (gridHeight * 9);
            ctx.fillRect(0, ninthRowY, canvas.width, gridHeight);
        }
        
        // é¡¯ç¤ºæŠ€èƒ½é¸æ“‡ç•Œé¢
        function showSkillSelection() {
            skillsContainer.innerHTML = '';
            
            const shuffledSkills = [...allSkills].sort(() => Math.random() - 0.5).slice(0, 3);
            
            shuffledSkills.forEach(skill => {
                const skillCard = document.createElement('div');
                skillCard.className = 'skill-card';
                skillCard.dataset.id = skill.id;
                
                skillCard.innerHTML = `
                    <div class="skill-icon">${skill.icon}</div>
                    <div class="skill-name">${skill.name}</div>
                    <div class="skill-desc">${skill.description}</div>
                `;
                
                skillCard.addEventListener('click', () => {
                    document.querySelectorAll('.skill-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    
                    skillCard.classList.add('selected');
                    game.selectedSkill = skill;
                    selectSkillBtn.textContent = `é–‹å§‹éŠæˆ²`;
                });
                
                skillsContainer.appendChild(skillCard);
            });
            
            skillSelection.style.display = 'flex';
            selectSkillBtn.textContent = `è«‹é¸æ“‡ä¸€å€‹æŠ€èƒ½`;
        }
        
        // æ›´æ–°æ´»å‹•æŠ€èƒ½é¡¯ç¤º
        function updateActiveSkillsDisplay() {
            activeSkillsElement.innerHTML = '';
            
            if (game.selectedSkill) {
                const skillEl = document.createElement('div');
                skillEl.className = 'active-skill';
                
                if (game.selectedSkill.effect === "bombImmunity") {
                    skillEl.innerHTML = `${game.selectedSkill.icon} ${game.selectedSkill.name} 
                        <span class="skill-charge">${game.bombImmunityCharges}/3</span>`;
                } else {
                    skillEl.innerHTML = `${game.selectedSkill.icon} ${game.selectedSkill.name}`;
                }
                
                activeSkillsElement.appendChild(skillEl);
            }
        }
        
        // åˆå§‹åŒ–éŠæˆ²
        function initGame() {
            game.score = 0;
            game.timeLeft = 60;
            game.elapsedSeconds = 0; // é‡ç½®ç¶“éç§’æ•¸
            game.isRunning = false;
            game.fruits = [];
            game.bombs = [];
            game.cutLines = [];
            game.combo = 1;
            game.missedFruits = 0;
            game.fruitInterval = 2000;
            game.lastFruitTime = 0;
            game.lastBombTime = 0;
            game.bonusFruitInterval = 1000;
            game.lastBonusFruitTime = 0;
            game.score1000Reached = false;
            game.bonusModeActive = false;
            game.bonusTimeLeft = 0;
            game.selectedSkill = null;
            game.bombImmunityCharges = 0;
            game.consecutiveCuts = 0;
            game.maxConsecutiveCuts = 0;
            game.missedSinceLastCut = false;
            
            scoreElement.textContent = '0';
            timeElement.textContent = 'æ™‚é–“: 60ç§’';
            fruitCountElement.textContent = 'æ°´æœ: 0';
            missedCounterElement.textContent = 'æ‰å‡º: 0';
            comboElement.textContent = 'x1';
            gameOverScreen.style.display = 'none';
            skillSelection.style.display = 'none';
            startGameBtn.textContent = 'é–‹å§‹éŠæˆ²';
            startGameBtn.disabled = false;
            score1000Badge.style.display = 'none';
            score1000Timer.style.display = 'none';
            
            if (game.animationId) cancelAnimationFrame(game.animationId);
            if (game.timerId) clearInterval(game.timerId);
            if (game.bonusTimerId) clearInterval(game.bonusTimerId);
            if (game.bonusFruitTimerId) clearInterval(game.bonusFruitTimerId);
            if (game.comboTimeout) clearTimeout(game.comboTimeout);
            
            activeSkillsElement.innerHTML = '';
        }
        
        // é–‹å§‹éŠæˆ²
        function startGame() {
            if (game.isRunning) return;
            
            if (!game.selectedSkill) {
                showSkillSelection();
                return;
            }
            
            applySkillEffects();
            
            game.isRunning = true;
            skillSelection.style.display = 'none';
            startGameBtn.textContent = 'éŠæˆ²ä¸­...';
            startGameBtn.disabled = true;
            
            updateActiveSkillsDisplay();
            
            game.timerId = setInterval(() => {
                game.timeLeft--;
                // å¯¦éš›ç¶“éç§’æ•¸ä¸å—æ™‚é–“å»¶é•·å½±éŸ¿ï¼Œæ°¸é å¾0é–‹å§‹å¾€ä¸ŠåŠ 
                game.elapsedSeconds++;
                
                timeElement.textContent = `æ™‚é–“: ${game.timeLeft}ç§’`;
                
                // ä¿®æ­£ï¼šä½¿ç”¨ game.elapsedSeconds ä¾†è¨ˆç®—é›£åº¦ï¼Œä¸å—æ™‚é–“å»¶é•·å½±éŸ¿
                if (game.fruitInterval > game.minInterval) {
                    // éš¨è‘—å¯¦éš›ç¶“éæ™‚é–“ï¼Œæ°´æœç”Ÿæˆé–“éš”è¶Šä¾†è¶ŠçŸ­
                    game.fruitInterval = Math.max(game.minInterval, 2000 - game.elapsedSeconds * 20);
                }
                
                if (game.timeLeft <= 0) {
                    endGame(true);
                }
            }, 1000);
            
            game.lastFruitTime = Date.now();
            
            gameLoop();
        }
        
        // æ‡‰ç”¨æŠ€èƒ½æ•ˆæœ
        function applySkillEffects() {
            if (game.selectedSkill && game.selectedSkill.effect === "extraTime") {
                game.timeLeft += 15;
                timeElement.textContent = `æ™‚é–“: ${game.timeLeft}ç§’`;
                // ä¸ä¿®æ”¹ elapsedSecondsï¼Œè®“é›£åº¦è¨ˆç®—ä¸å—å½±éŸ¿
            }
            
            if (game.selectedSkill && game.selectedSkill.effect === "bombImmunity") {
                game.bombImmunityCharges = 3;
            }
        }
        
        // çµæŸéŠæˆ²
        function endGame(isTimeUp) {
            game.isRunning = false;
            game.score1000Reached = false;
            game.bonusModeActive = false;
            
            clearInterval(game.timerId);
            clearInterval(game.bonusTimerId);
            clearInterval(game.bonusFruitTimerId);
            cancelAnimationFrame(game.animationId);
            
            finalScoreElement.textContent = game.score;
            
            if (game.score < 0) {
                gameOverTitle.textContent = 'éŠæˆ²çµæŸ (è² åˆ†)';
                gameOverTitle.style.color = '#ff4d6d';
            } else if (isTimeUp) {
                gameOverTitle.textContent = 'æ™‚é–“åˆ°!';
                gameOverTitle.style.color = '#5a9cff';
            } else {
                gameOverTitle.textContent = 'éŠæˆ²çµæŸ';
                gameOverTitle.style.color = '#ff6b8b';
            }
            
            gameOverScreen.style.display = 'flex';
            startGameBtn.textContent = 'é–‹å§‹éŠæˆ²';
            startGameBtn.disabled = false;
            score1000Badge.style.display = 'none';
            score1000Timer.style.display = 'none';
        }
        
        // éŠæˆ²ä¸»å¾ªç’°
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            drawGridBackground();
            
            if (game.isRunning) {
                const currentTime = Date.now();
                if (currentTime - game.lastFruitTime > game.fruitInterval) {
                    // ä¿®æ­£ï¼šä½¿ç”¨ game.elapsedSeconds ä¾†è¨ˆç®—æ°´æœæ•¸é‡ï¼Œä¸å—æ™‚é–“å»¶é•·å½±éŸ¿
                    // æ¯5ç§’å¢åŠ ä¸€å€‹æ°´æœï¼Œè®“ç©å®¶èƒ½åœ¨35ç§’å·¦å³é”åˆ°1000åˆ†
                    const baseCount = Math.floor(game.elapsedSeconds / 5) + 1;
                    const fruitCount = Math.min(5, baseCount); // æœ€å¤š5å€‹
                    
                    for (let i = 0; i < fruitCount; i++) {
                        setTimeout(() => {
                            if (game.isRunning) {
                                game.fruits.push(new Fruit());
                                fruitCountElement.textContent = `æ°´æœ: ${game.fruits.length}`;
                            }
                        }, i * 300);
                    }
                    
                    game.lastFruitTime = currentTime;
                }
                
                if (game.score >= 60 && currentTime - game.lastBombTime > game.bombInterval) {
                    game.bombs.push(new Bomb());
                    game.lastBombTime = currentTime;
                }
            }
            
            for (let i = game.fruits.length - 1; i >= 0; i--) {
                const fruit = game.fruits[i];
                const shouldRemove = fruit.update();
                
                if (shouldRemove) {
                    game.fruits.splice(i, 1);
                    fruitCountElement.textContent = `æ°´æœ: ${game.fruits.length}`;
                } else {
                    fruit.draw();
                }
            }
            
            for (let i = game.bombs.length - 1; i >= 0; i--) {
                const bomb = game.bombs[i];
                const shouldRemove = bomb.update();
                
                if (shouldRemove) {
                    game.bombs.splice(i, 1);
                } else {
                    bomb.draw();
                }
            }
            
            for (let i = game.cutLines.length - 1; i >= 0; i--) {
                const line = game.cutLines[i];
                line.life--;
                
                if (line.life <= 0) {
                    game.cutLines.splice(i, 1);
                } else {
                    drawCutLine(line);
                }
            }
            
            if (game.isRunning) {
                game.animationId = requestAnimationFrame(gameLoop);
            }
        }
        
        // ç¹ªè£½åˆ‡å‰²ç·š
        function drawCutLine(line) {
            const gradient = ctx.createLinearGradient(line.x1, line.y1, line.x2, line.y2);
            gradient.addColorStop(0, line.color + 'FF');
            gradient.addColorStop(1, line.color + '00');
            
            ctx.strokeStyle = gradient;
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.globalAlpha = line.life / 30;
            
            ctx.beginPath();
            ctx.moveTo(line.x1, line.y1);
            ctx.lineTo(line.x2, line.y2);
            ctx.stroke();
            
            ctx.globalAlpha = 1.0;
        }
        
        // åˆ‡å‰²ç‰©é«”
        function sliceObject(x1, y1, x2, y2) {
            if (!game.isRunning) return;
            
            let slicedAny = false;
            
            for (let i = 0; i < game.fruits.length; i++) {
                const fruit = game.fruits[i];
                
                if (lineIntersectsCircle(x1, y1, x2, y2, fruit.x, fruit.y, fruit.radius)) {
                    if (fruit.slice()) {
                        slicedAny = true;
                        
                        if (game.score < 0) {
                            endGame(false);
                            return;
                        }
                    }
                }
            }
            
            for (let i = 0; i < game.bombs.length; i++) {
                const bomb = game.bombs[i];
                
                if (lineIntersectsCircle(x1, y1, x2, y2, bomb.x, bomb.y, bomb.radius)) {
                    if (bomb.explode()) {
                        slicedAny = true;
                        
                        if (game.selectedSkill && game.selectedSkill.effect === "bombImmunity") {
                            updateActiveSkillsDisplay();
                        }
                        
                        if (game.score < 0) {
                            endGame(false);
                            return;
                        }
                    }
                }
            }
            
            if (slicedAny || Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2) > 10) {
                const colorIndex = Math.floor(Math.random() * colors.length);
                game.cutLines.push({
                    x1: x1,
                    y1: y1,
                    x2: x2,
                    y2: y2,
                    color: colors[colorIndex],
                    life: 30
                });
            }
        }
        
        // æª¢æŸ¥ç·šæ®µèˆ‡åœ“æ˜¯å¦ç›¸äº¤
        function lineIntersectsCircle(x1, y1, x2, y2, cx, cy, r) {
            const mx = (x1 + x2) / 2;
            const my = (y1 + y2) / 2;
            const distance = Math.sqrt((mx - cx) ** 2 + (my - cy) ** 2);
            
            return distance < r + 10;
        }
        
        // äº‹ä»¶ç›£è½å™¨
        startGameBtn.addEventListener('click', () => {
            if (!game.selectedSkill) {
                showSkillSelection();
            } else {
                startGame();
            }
        });
        
        selectSkillBtn.addEventListener('click', () => {
            if (game.selectedSkill) {
                startGame();
            } else {
                alert('è«‹é¸æ“‡ä¸€å€‹æŠ€èƒ½ï¼');
            }
        });
        
        restartBtn.addEventListener('click', () => {
            initGame();
            showSkillSelection();
        });
        
        let isMouseDown = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        
        canvas.addEventListener('mousedown', (e) => {
            isMouseDown = true;
            const rect = canvas.getBoundingClientRect();
            lastMouseX = e.clientX - rect.left;
            lastMouseY = e.clientY - rect.top;
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (!isMouseDown) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            sliceObject(lastMouseX, lastMouseY, x, y);
            
            lastMouseX = x;
            lastMouseY = y;
        });
        
        canvas.addEventListener('mouseup', () => {
            isMouseDown = false;
        });
        
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            lastMouseX = touch.clientX - rect.left;
            lastMouseY = touch.clientY - rect.top;
            isMouseDown = true;
        });
        
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!isMouseDown) return;
            
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            sliceObject(lastMouseX, lastMouseY, x, y);
            
            lastMouseX = x;
            lastMouseY = y;
        });
        
        canvas.addEventListener('touchend', () => {
            isMouseDown = false;
        });
        
        window.addEventListener('resize', () => {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            gridHeight = canvas.height / GRID_ROWS;
            NINTH_ROW_HEIGHT = gridHeight * 3;
        });
        
        initGame();
        
        drawGridBackground();
        ctx.fillStyle = '#ff6b8b';
        ctx.font = '28px Arial Rounded MT Bold';
        ctx.textAlign = 'center';
        ctx.fillText('åˆ‡å§æ°´æœ', canvas.width / 2, canvas.height / 2 - 30);
        ctx.fillStyle = '#666';
        ctx.font = '16px Arial';
        ctx.fillText('é»æ“Šå·¦ä¸‹è§’é–‹å§‹éŠæˆ²æŒ‰éˆ•', canvas.width / 2, canvas.height / 2 + 20);
    </script>
</body>
</html>