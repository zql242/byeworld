<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ‡å§æ°´æœ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #333;
        }
        
        .header {
            width: 100%;
            max-width: 900px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }
        
        .game-title {
            color: #ff6b8b;
            font-size: 48px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .main-container {
            display: flex;
            width: 100%;
            max-width: 900px;
            gap: 20px;
        }
        
        .game-area {
            flex: 3;
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            background-color: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid #eaeaea;
        }
        
        #gameCanvas {
            width: 100%;
            height: 500px;
            display: block;
            background-color: #ffffff;
        }
        
        .side-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .score-container {
            background-color: #ffffff;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 2px solid #eaeaea;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .score-title {
            color: #666;
            font-size: 16px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .score {
            color: #ff6b8b;
            font-size: 48px;
            font-weight: bold;
        }
        
        .combo-container {
            background-color: #ffffff;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 2px solid #eaeaea;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .combo-title {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .combo {
            color: #5a9cff;
            font-size: 32px;
            font-weight: bold;
        }
        
        .controls-container {
            background-color: #ffffff;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 2px solid #eaeaea;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-top: auto;
        }
        
        .start-btn {
            background: linear-gradient(to bottom, #ff6b8b, #ff4d6d);
            color: white;
            border: none;
            padding: 15px 25px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(255, 107, 139, 0.2);
        }
        
        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 107, 139, 0.3);
        }
        
        .start-btn:active {
            transform: translateY(1px);
        }
        
        .footer {
            width: 100%;
            max-width: 900px;
            margin-top: 20px;
            background-color: #ffffff;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #eaeaea;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .rules-title {
            color: #333;
            font-size: 20px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            color: #ff6b8b;
        }
        
        .rules-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 15px;
        }
        
        .rule-item {
            flex: 1;
            min-width: 180px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #5a9cff;
        }
        
        .rule-item h4 {
            color: #5a9cff;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .rule-item p {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            border-radius: 15px;
        }
        
        .game-over h1 {
            color: #ff4d6d;
            font-size: 48px;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .final-score {
            color: #ff6b8b;
            font-size: 60px;
            font-weight: bold;
            margin-bottom: 30px;
        }
        
        .restart-btn {
            background: linear-gradient(to bottom, #5a9cff, #3a7cdf);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(90, 156, 255, 0.2);
        }
        
        .game-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: #666;
            font-size: 14px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #eaeaea;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .fruit-count {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #666;
            font-size: 16px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #eaeaea;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .time-container {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #666;
            font-size: 16px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #eaeaea;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .start-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 10;
        }
        
        .start-game-btn {
            background: linear-gradient(to bottom, #ff6b8b, #ff4d6d);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(255, 107, 139, 0.3);
        }
        
        .start-game-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 107, 139, 0.4);
        }
        
        .start-game-btn:active {
            transform: translateY(1px);
        }
        
        .cut-effect {
            position: absolute;
            pointer-events: none;
            z-index: 5;
        }
        
        /* ç°¡åŒ–ç‰ˆæŠ€èƒ½é¸æ“‡ç•Œé¢ */
        .skill-selection {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 15;
            border-radius: 15px;
        }
        
        .skill-title {
            color: #ff6b8b;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .skills-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            max-width: 90%;
            margin-bottom: 25px;
        }
        
        .skill-card {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 15px;
            width: 150px;
            text-align: center;
            border: 2px solid #eaeaea;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .skill-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border-color: #5a9cff;
        }
        
        .skill-card.selected {
            border-color: #ff6b8b;
            background-color: rgba(255, 107, 139, 0.05);
            transform: scale(1.05);
        }
        
        .skill-icon {
            font-size: 30px;
            margin-bottom: 10px;
            height: 35px;
        }
        
        .skill-name {
            color: #333;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .skill-desc {
            color: #666;
            font-size: 12px;
            line-height: 1.3;
        }
        
        .select-skill-btn {
            background: linear-gradient(to bottom, #5a9cff, #3a7cdf);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(90, 156, 255, 0.2);
        }
        
        .active-skills {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 5;
        }
        
        .active-skill {
            background-color: rgba(90, 156, 255, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .bomb-warning {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            z-index: 10;
            display: none;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .game-title {
                font-size: 36px;
            }
            
            .score {
                font-size: 36px;
            }
            
            .combo {
                font-size: 24px;
            }
            
            .skills-container {
                flex-direction: column;
                align-items: center;
            }
            
            .skill-card {
                width: 80%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="game-title">åˆ‡å§æ°´æœ</h1>
    </div>
    
    <div class="main-container">
        <div class="game-area">
            <canvas id="gameCanvas"></canvas>
            
            <div class="time-container" id="timeContainer">æ™‚é–“: 60ç§’</div>
            <div class="fruit-count" id="fruitCount">æ°´æœ: 0</div>
            
            <div class="start-container">
                <button class="start-game-btn" id="startGameBtn">é–‹å§‹éŠæˆ²</button>
            </div>
            
            <div class="active-skills" id="activeSkills"></div>
            
            <div class="bomb-warning" id="bombWarning">âš ï¸ ç‚¸å½ˆï¼æ‰£1000åˆ†ï¼ âš ï¸</div>
            
            <!-- ç°¡åŒ–ç‰ˆæŠ€èƒ½é¸æ“‡ç•Œé¢ - åªé¡¯ç¤º3å€‹éš¨æ©ŸæŠ€èƒ½ -->
            <div class="skill-selection" id="skillSelection">
                <h2 class="skill-title">é¸æ“‡ä¸€å€‹æŠ€èƒ½é–‹å§‹éŠæˆ²</h2>
                <div class="skills-container" id="skillsContainer">
                    <!-- åªé¡¯ç¤º3å€‹éš¨æ©ŸæŠ€èƒ½å¡ç‰‡ -->
                </div>
                <button class="select-skill-btn" id="selectSkillBtn">é–‹å§‹éŠæˆ²</button>
            </div>
            
            <div class="game-over" id="gameOverScreen">
                <h1 id="gameOverTitle">éŠæˆ²çµæŸ</h1>
                <div class="final-score" id="finalScore">0</div>
                <button class="restart-btn" id="restartBtn">é‡æ–°é–‹å§‹</button>
            </div>
        </div>
        
        <div class="side-panel">
            <div class="score-container">
                <div class="score-title">åˆ†æ•¸</div>
                <div class="score" id="score">0</div>
            </div>
            
            <div class="combo-container">
                <div class="combo-title">é€£æ“Š</div>
                <div class="combo" id="combo">x1</div>
            </div>
            
            <div class="controls-container">
                <h3>éŠæˆ²èªªæ˜</h3>
                <p style="margin-top: 10px; color: #666; font-size: 14px; line-height: 1.5;">
                    1. æ¯å€‹æ°´æœ+10åˆ†<br>
                    2. ç‚¸å½ˆæ‰£1000åˆ† (åˆ†æ•¸â‰¥60åˆ†å‡ºç¾)<br>
                    3. åˆ‡åˆ°ç‚¸å½ˆä¸å½±éŸ¿é€£æ“Š<br>
                    4. 60ç§’æ™‚é–“é™åˆ¶<br>
                    5. é–‹å§‹å‰é¸æ“‡ä¸€å€‹æŠ€èƒ½
                </p>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <h3 class="rules-title">éŠæˆ²è¦å‰‡</h3>
        <div class="rules-list">
            <div class="rule-item">
                <h4>è¨ˆåˆ†è¦å‰‡</h4>
                <p>åˆ‡ä¸­ä¸€å€‹æ°´æœåŠ 10åˆ†ï¼ŒéŒ¯éä¸€å€‹æ°´æœæ‰£5åˆ†ã€‚åˆ†æ•¸è®Šç‚ºè² æ•¸æ™‚éŠæˆ²ç«‹å³çµæŸã€‚</p>
            </div>
            <div class="rule-item">
                <h4>ç‚¸å½ˆç³»çµ±</h4>
                <p>ç•¶åˆ†æ•¸é”åˆ°60åˆ†ä»¥ä¸Šæ™‚æœƒå‡ºç¾é»‘è‰²ç‚¸å½ˆã€‚åˆ‡å‰²ç‚¸å½ˆæœƒæ‰£é™¤1000åˆ†ï¼è«‹å‹™å¿…å°å¿ƒé¿é–‹ï¼</p>
            </div>
            <div class="rule-item">
                <h4>é€£æ“Šç³»çµ±</h4>
                <p>é€£çºŒåˆ‡å‰²æ°´æœæœƒå¢åŠ é€£æ“Šå€æ•¸ï¼Œåˆ‡åˆ°ç‚¸å½ˆä¸æœƒä¸­æ–·é€£æ“Šã€‚æ°´æœå°ºå¯¸è®Šå¤§æ›´å®¹æ˜“åˆ‡å‰²ã€‚</p>
            </div>
            <div class="rule-item">
                <h4>æŠ€èƒ½ç³»çµ±</h4>
                <p>é–‹å§‹å‰å¾3å€‹éš¨æ©ŸæŠ€èƒ½ä¸­é¸æ“‡1å€‹ã€‚æŠ€èƒ½æœƒå¸¶ä¾†å„ç¨®åŠ æˆæ•ˆæœã€‚</p>
            </div>
        </div>
    </div>

    <script>
        // éŠæˆ²è®Šé‡
        let canvas = document.getElementById('gameCanvas');
        let ctx = canvas.getContext('2d');
        let scoreElement = document.getElementById('score');
        let timeElement = document.getElementById('timeContainer');
        let fruitCountElement = document.getElementById('fruitCount');
        let comboElement = document.getElementById('combo');
        let startGameBtn = document.getElementById('startGameBtn');
        let gameOverScreen = document.getElementById('gameOverScreen');
        let gameOverTitle = document.getElementById('gameOverTitle');
        let finalScoreElement = document.getElementById('finalScore');
        let restartBtn = document.getElementById('restartBtn');
        let skillSelection = document.getElementById('skillSelection');
        let skillsContainer = document.getElementById('skillsContainer');
        let selectSkillBtn = document.getElementById('selectSkillBtn');
        let bombWarning = document.getElementById('bombWarning');
        let activeSkillsElement = document.getElementById('activeSkills');
        
        // è¨­ç½®ç•«å¸ƒå¤§å°
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        
        // è¨ˆç®—ç¬¬9æ ¼çš„é«˜åº¦ï¼ˆå°‡ç•«å¸ƒåˆ†ç‚º12æ ¼ï¼‰
        const GRID_ROWS = 12;
        let gridHeight = canvas.height / GRID_ROWS;
        let NINTH_ROW_HEIGHT = gridHeight * 3;
        
        // éŠæˆ²ç‹€æ…‹
        let game = {
            score: 0,
            timeLeft: 60,
            isRunning: false,
            fruits: [],
            bombs: [],
            cutLines: [],
            combo: 1,
            comboTimeout: null,
            lastCutTime: 0,
            missedFruits: 0,
            fruitInterval: 2000,
            minInterval: 500,
            lastFruitTime: 0,
            lastBombTime: 0,
            bombInterval: 5000,
            animationId: null,
            timerId: null,
            selectedSkill: null,
            consecutiveCuts: 0,
            maxConsecutiveCuts: 0
        };
        
        // æŠ€èƒ½å®šç¾©
        const allSkills = [
            {
                id: 1,
                name: "é›™å€åˆ†æ•¸",
                icon: "ğŸ’°",
                description: "æ¯æ¬¡åˆ‡å‰²æ°´æœç²å¾—é›™å€åˆ†æ•¸",
                effect: "doubleScore"
            },
            {
                id: 2,
                name: "æ™‚é–“å»¶é•·",
                icon: "â±ï¸",
                description: "éŠæˆ²æ™‚é–“å¢åŠ 15ç§’",
                effect: "extraTime"
            },
            {
                id: 3,
                name: "å¿«é€Ÿé€£æ“Š",
                icon: "âš¡",
                description: "é€£æ“ŠæŒçºŒæ™‚é–“å»¶é•·3ç§’",
                effect: "longerCombo"
            },
            {
                id: 4,
                name: "ç‚¸å½ˆå…ç–«",
                icon: "ğŸ›¡ï¸",
                description: "åˆ‡å‰²ç‚¸å½ˆä¸æœƒæ‰£åˆ†",
                effect: "bombImmunity"
            },
            {
                id: 5,
                name: "é€£æ“Šå¤§å¸«",
                icon: "ğŸ‘‘",
                description: "é€£çºŒåˆ‡å‰²8å€‹æ°´æœè§¸ç™¼å…¨å±çˆ†ç‚¸",
                effect: "comboMaster"
            },
            {
                id: 6,
                name: "å¹¸é‹åˆ‡å‰²",
                icon: "ğŸ€",
                description: "æœ‰15%æ©Ÿç‡ç²å¾—3å€åˆ†æ•¸",
                effect: "luckyCut"
            }
        ];
        
        // é®®è±”çš„æ°´æœé¡è‰²
        const colors = [
            '#FF6B8B', // ç²‰ç´…è‰²
            '#5A9CFF', // è—è‰²
            '#4CD964', // ç¶ è‰²
            '#FFCC00', // é»ƒè‰²
            '#AF52DE'  // ç´«è‰²
        ];
        
        // æ°´æœé¡å‹ - ç§»é™¤æ‰€æœ‰ç‰¹æ®ŠåŠŸèƒ½ï¼Œåªæœ‰åŸºæœ¬æ°´æœ
        const fruitTypes = [
            { 
                name: 'è¥¿ç“œ', 
                color: '#4CD964', 
                points: 10,
                radius: 40  // æ›´å¤§çš„æ°´æœ
            },
            { 
                name: 'è‰è“', 
                color: '#FF6B8B', 
                points: 10,
                radius: 40
            },
            { 
                name: 'è—è“', 
                color: '#5A9CFF', 
                points: 10,
                radius: 38
            },
            { 
                name: 'æª¸æª¬', 
                color: '#FFCC00', 
                points: 10,
                radius: 42
            },
            { 
                name: 'è‘¡è„', 
                color: '#AF52DE', 
                points: 10,
                radius: 36
            }
        ];
        
        // æ°´æœé¡ - ç§»é™¤æ‰€æœ‰ç‰¹æ®ŠåŠŸèƒ½
        class Fruit {
            constructor(type) {
                this.type = type || fruitTypes[Math.floor(Math.random() * fruitTypes.length)];
                this.radius = this.type.radius + Math.random() * 5; // æ›´å¤§çš„æ°´æœ
                this.x = this.radius + Math.random() * (canvas.width - 2 * this.radius);
                this.y = canvas.height + this.radius;
                
                const targetHeight = NINTH_ROW_HEIGHT;
                const gravity = 0.25;
                
                // ä½¿ç”¨ç‰©ç†å…¬å¼è¨ˆç®—éœ€è¦çš„åˆé€Ÿåº¦
                const requiredSpeed = Math.sqrt(2 * gravity * (canvas.height - targetHeight));
                
                this.speedX = (Math.random() - 0.5) * 3;
                this.speedY = -requiredSpeed;
                this.gravity = gravity;
                this.rotation = 0;
                this.rotationSpeed = (Math.random() - 0.5) * 0.05;
                this.isSliced = false;
                this.slicedTime = 0;
                this.color = this.type.color;
                this.hasScored = false;
            }
            
            update() {
                if (!this.isSliced) {
                    this.x += this.speedX;
                    this.y += this.speedY;
                    this.speedY += this.gravity;
                    this.rotation += this.rotationSpeed;
                    
                    // é‚Šç•Œåå½ˆ
                    if (this.x < this.radius || this.x > canvas.width - this.radius) {
                        this.speedX *= -0.8;
                        this.x = this.x < this.radius ? this.radius : canvas.width - this.radius;
                    }
                } else {
                    this.slicedTime++;
                }
                
                // å¦‚æœæ°´æœæ‰å‡ºå±å¹•ä¸”æ²’æœ‰è¢«åˆ‡å‰²ï¼Œæ‰£åˆ†
                if (!this.isSliced && this.y > canvas.height + this.radius && !this.hasScored) {
                    this.hasScored = true;
                    
                    game.score -= 5;
                    scoreElement.textContent = game.score;
                    
                    game.missedFruits++;
                    game.combo = 1;
                    comboElement.textContent = 'x1';
                    game.consecutiveCuts = 0;
                    
                    // æª¢æŸ¥æ˜¯å¦è² åˆ†
                    if (game.score < 0 && game.isRunning) {
                        endGame(false);
                    }
                }
                
                return this.y > canvas.height + 100 || this.slicedTime > 30;
            }
            
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                
                if (!this.isSliced) {
                    // ç¹ªè£½æ°´æœä¸»é«”
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // æ°´æœé«˜å…‰
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                    ctx.beginPath();
                    ctx.arc(-this.radius * 0.3, -this.radius * 0.3, this.radius * 0.4, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // æ°´æœè‘‰å­
                    ctx.fillStyle = '#4CD964';
                    ctx.beginPath();
                    ctx.ellipse(0, -this.radius * 0.8, this.radius * 0.6, this.radius * 0.3, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // æ°´æœé™°å½±
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
                    ctx.shadowBlur = 8;
                    ctx.shadowOffsetY = 3;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    ctx.shadowOffsetY = 0;
                    
                    // æ°´æœåç¨±
                    ctx.fillStyle = '#333';
                    ctx.font = `bold ${Math.floor(this.radius/4)}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(this.type.name, 0, this.radius + 10);
                } else {
                    // ç¹ªè£½åˆ‡å‰²å¾Œçš„æ°´æœ
                    const sliceAngle = Math.PI / 4;
                    
                    // å·¦åŠéƒ¨åˆ†
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(-this.radius * 0.3, 0, this.radius, sliceAngle, Math.PI * 2 - sliceAngle);
                    ctx.closePath();
                    ctx.fill();
                    
                    // å³åŠéƒ¨åˆ†
                    ctx.beginPath();
                    ctx.arc(this.radius * 0.3, 0, this.radius, Math.PI + sliceAngle, Math.PI * 3 - sliceAngle);
                    ctx.closePath();
                    ctx.fill();
                    
                    // æœæ±é£›æ¿º
                    for (let i = 0; i < 8; i++) {
                        const angle = Math.random() * Math.PI * 2;
                        const distance = Math.random() * this.radius * 1.5;
                        const juiceX = Math.cos(angle) * distance;
                        const juiceY = Math.sin(angle) * distance;
                        const juiceSize = Math.random() * 5 + 2;
                        
                        ctx.fillStyle = this.color;
                        ctx.beginPath();
                        ctx.arc(juiceX, juiceY, juiceSize, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
                
                ctx.restore();
            }
            
            slice() {
                if (!this.isSliced && !this.hasScored) {
                    this.isSliced = true;
                    this.hasScored = true;
                    
                    // è¨ˆç®—åŸºç¤åˆ†æ•¸
                    let points = this.type.points * game.combo;
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰"é›™å€åˆ†æ•¸"æŠ€èƒ½
                    if (game.selectedSkill && game.selectedSkill.effect === "doubleScore") {
                        points *= 2;
                    }
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰"å¹¸é‹åˆ‡å‰²"æŠ€èƒ½
                    if (game.selectedSkill && game.selectedSkill.effect === "luckyCut" && Math.random() < 0.15) {
                        points *= 3;
                    }
                    
                    game.score += points;
                    scoreElement.textContent = game.score;
                    
                    // å¢åŠ é€£æ“Šå’Œé€£çºŒåˆ‡å‰²è¨ˆæ•¸
                    const currentTime = Date.now();
                    if (currentTime - game.lastCutTime < 1000) {
                        game.combo = Math.min(10, game.combo + 1);
                        game.consecutiveCuts++;
                        
                        // æª¢æŸ¥æ˜¯å¦è§¸ç™¼"é€£æ“Šå¤§å¸«"æ•ˆæœ
                        if (game.consecutiveCuts >= 8) {
                            if (game.selectedSkill && game.selectedSkill.effect === "comboMaster") {
                                triggerComboMaster();
                            }
                        }
                    } else {
                        game.combo = 1;
                        game.consecutiveCuts = 1;
                    }
                    
                    game.lastCutTime = currentTime;
                    
                    comboElement.textContent = `x${game.combo}`;
                    
                    // é‡ç½®é€£æ“Šè¨ˆæ™‚å™¨
                    if (game.comboTimeout) clearTimeout(game.comboTimeout);
                    
                    const comboDuration = (game.selectedSkill && game.selectedSkill.effect === "longerCombo") ? 3000 : 1500;
                    game.comboTimeout = setTimeout(() => {
                        game.combo = 1;
                        comboElement.textContent = 'x1';
                        game.consecutiveCuts = 0;
                    }, comboDuration);
                    
                    return true;
                }
                return false;
            }
        }
        
        // ç‚¸å½ˆé¡
        class Bomb {
            constructor() {
                this.radius = 35; // æ›´å¤§çš„ç‚¸å½ˆ
                this.x = this.radius + Math.random() * (canvas.width - 2 * this.radius);
                this.y = canvas.height + this.radius;
                
                const targetHeight = NINTH_ROW_HEIGHT;
                const gravity = 0.25;
                const requiredSpeed = Math.sqrt(2 * gravity * (canvas.height - targetHeight));
                
                this.speedX = (Math.random() - 0.5) * 2;
                this.speedY = -requiredSpeed * 0.8;
                this.gravity = gravity;
                this.rotation = 0;
                this.rotationSpeed = (Math.random() - 0.5) * 0.03;
                this.isExploded = false;
                this.explodedTime = 0;
                this.color = '#000000';
            }
            
            update() {
                if (!this.isExploded) {
                    this.x += this.speedX;
                    this.y += this.speedY;
                    this.speedY += this.gravity;
                    this.rotation += this.rotationSpeed;
                    
                    // é‚Šç•Œåå½ˆ
                    if (this.x < this.radius || this.x > canvas.width - this.radius) {
                        this.speedX *= -0.8;
                        this.x = this.x < this.radius ? this.radius : canvas.width - this.radius;
                    }
                } else {
                    this.explodedTime++;
                }
                
                return this.y > canvas.height + 100 || this.explodedTime > 30;
            }
            
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                
                if (!this.isExploded) {
                    // ç¹ªè£½ç‚¸å½ˆä¸»é«”
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ç‚¸å½ˆå¼•ä¿¡
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(-4, -this.radius - 8, 8, 15);
                    
                    // ç‚¸å½ˆè­¦å‘Šæ¨™èªŒ
                    ctx.fillStyle = '#FF0000';
                    ctx.beginPath();
                    ctx.moveTo(0, -this.radius * 0.5);
                    ctx.lineTo(this.radius * 0.4, this.radius * 0.2);
                    ctx.lineTo(-this.radius * 0.4, this.radius * 0.2);
                    ctx.closePath();
                    ctx.fill();
                    
                    // ç‚¸å½ˆæ–‡å­—
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = 'bold 18px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('-1000', 0, 0);
                    
                    // ç‚¸å½ˆé™°å½±
                    ctx.shadowColor = 'rgba(255, 0, 0, 0.5)';
                    ctx.shadowBlur = 15;
                    ctx.shadowOffsetY = 3;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    ctx.shadowOffsetY = 0;
                } else {
                    // ç¹ªè£½çˆ†ç‚¸æ•ˆæœ
                    ctx.fillStyle = '#FF9500';
                    for (let i = 0; i < 12; i++) {
                        const angle = (i * Math.PI * 2) / 12;
                        const distance = this.radius * 2;
                        const sparkX = Math.cos(angle) * distance;
                        const sparkY = Math.sin(angle) * distance;
                        const sparkSize = Math.random() * 10 + 5;
                        
                        ctx.beginPath();
                        ctx.arc(sparkX, sparkY, sparkSize, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    ctx.fillStyle = '#FF0000';
                    ctx.beginPath();
                    ctx.arc(0, 0, this.radius * 1.5, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                ctx.restore();
            }
            
            explode() {
                if (!this.isExploded) {
                    this.isExploded = true;
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰"ç‚¸å½ˆå…ç–«"æŠ€èƒ½
                    const hasBombImmunity = game.selectedSkill && game.selectedSkill.effect === "bombImmunity";
                    
                    if (!hasBombImmunity) {
                        // ç‚¸å½ˆæ‰£1000åˆ†ï¼
                        game.score -= 1000;
                        scoreElement.textContent = game.score;
                        
                        // é¡¯ç¤ºè­¦å‘Š
                        bombWarning.style.display = 'block';
                        setTimeout(() => {
                            bombWarning.style.display = 'none';
                        }, 2000);
                        
                        // æª¢æŸ¥æ˜¯å¦è² åˆ†
                        if (game.score < 0 && game.isRunning) {
                            endGame(false);
                        }
                    }
                    
                    // åˆ‡åˆ°ç‚¸å½ˆä¸æœƒé‡ç½®é€£æ“Šï¼
                    
                    return true;
                }
                return false;
            }
        }
        
        // è§¸ç™¼é€£æ“Šå¤§å¸«æ•ˆæœ
        function triggerComboMaster() {
            // æ¸…é™¤å±å¹•ä¸Šæ‰€æœ‰æ°´æœ
            for (let i = game.fruits.length - 1; i >= 0; i--) {
                const fruit = game.fruits[i];
                if (!fruit.isSliced) {
                    fruit.isSliced = true;
                    fruit.hasScored = true;
                    game.score += fruit.type.points * 2;
                    scoreElement.textContent = game.score;
                }
            }
            
            // æ·»åŠ çˆ†ç‚¸æ•ˆæœ
            for (let i = 0; i < 20; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const size = Math.random() * 20 + 10;
                
                game.cutLines.push({
                    x1: x,
                    y1: y,
                    x2: x + Math.random() * 100 - 50,
                    y2: y + Math.random() * 100 - 50,
                    color: '#FF0000',
                    life: 20
                });
            }
            
            // é‡ç½®é€£çºŒåˆ‡å‰²è¨ˆæ•¸
            game.consecutiveCuts = 0;
        }
        
        // ç¹ªè£½ç¶²æ ¼èƒŒæ™¯
        function drawGridBackground() {
            ctx.strokeStyle = '#f0f0f0';
            ctx.lineWidth = 1;
            
            // ç¹ªè£½ç¶²æ ¼ç·š
            for (let x = 0; x <= canvas.width; x += canvas.width / 12) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            for (let y = 0; y <= canvas.height; y += canvas.height / 12) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // æ¨™è¨˜ç¬¬9æ ¼ï¼ˆå¾åº•éƒ¨æ•¸ï¼‰
            ctx.fillStyle = 'rgba(255, 107, 139, 0.1)';
            const ninthRowY = canvas.height - (gridHeight * 9);
            ctx.fillRect(0, ninthRowY, canvas.width, gridHeight);
        }
        
        // é¡¯ç¤ºæŠ€èƒ½é¸æ“‡ç•Œé¢
        function showSkillSelection() {
            // æ¸…ç©ºæŠ€èƒ½å®¹å™¨
            skillsContainer.innerHTML = '';
            
            // éš¨æ©Ÿé¸æ“‡3å€‹æŠ€èƒ½
            const shuffledSkills = [...allSkills].sort(() => Math.random() - 0.5).slice(0, 3);
            
            // å‰µå»ºæŠ€èƒ½å¡ç‰‡
            shuffledSkills.forEach(skill => {
                const skillCard = document.createElement('div');
                skillCard.className = 'skill-card';
                skillCard.dataset.id = skill.id;
                
                skillCard.innerHTML = `
                    <div class="skill-icon">${skill.icon}</div>
                    <div class="skill-name">${skill.name}</div>
                    <div class="skill-desc">${skill.description}</div>
                `;
                
                skillCard.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰å¡ç‰‡çš„é¸æ“‡ç‹€æ…‹
                    document.querySelectorAll('.skill-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    
                    // è¨­ç½®ç•¶å‰å¡ç‰‡ç‚ºé¸æ“‡ç‹€æ…‹
                    skillCard.classList.add('selected');
                    
                    // è¨­ç½®é¸æ“‡çš„æŠ€èƒ½
                    game.selectedSkill = skill;
                    
                    // æ›´æ–°æŒ‰éˆ•æ–‡å­—
                    selectSkillBtn.textContent = `é–‹å§‹éŠæˆ²`;
                });
                
                skillsContainer.appendChild(skillCard);
            });
            
            // é¡¯ç¤ºæŠ€èƒ½é¸æ“‡ç•Œé¢
            skillSelection.style.display = 'flex';
            selectSkillBtn.textContent = `è«‹é¸æ“‡ä¸€å€‹æŠ€èƒ½`;
        }
        
        // æ›´æ–°æ´»å‹•æŠ€èƒ½é¡¯ç¤º
        function updateActiveSkillsDisplay() {
            activeSkillsElement.innerHTML = '';
            
            if (game.selectedSkill) {
                const skillEl = document.createElement('div');
                skillEl.className = 'active-skill';
                skillEl.innerHTML = `${game.selectedSkill.icon} ${game.selectedSkill.name}`;
                activeSkillsElement.appendChild(skillEl);
            }
        }
        
        // åˆå§‹åŒ–éŠæˆ²
        function initGame() {
            game.score = 0;
            game.timeLeft = 60;
            game.isRunning = false;
            game.fruits = [];
            game.bombs = [];
            game.cutLines = [];
            game.combo = 1;
            game.missedFruits = 0;
            game.fruitInterval = 2000;
            game.lastFruitTime = 0;
            game.lastBombTime = 0;
            game.selectedSkill = null;
            game.consecutiveCuts = 0;
            game.maxConsecutiveCuts = 0;
            
            scoreElement.textContent = '0';
            timeElement.textContent = 'æ™‚é–“: 60ç§’';
            fruitCountElement.textContent = 'æ°´æœ: 0';
            comboElement.textContent = 'x1';
            gameOverScreen.style.display = 'none';
            skillSelection.style.display = 'none';
            startGameBtn.textContent = 'é–‹å§‹éŠæˆ²';
            startGameBtn.disabled = false;
            
            if (game.animationId) cancelAnimationFrame(game.animationId);
            if (game.timerId) clearInterval(game.timerId);
            if (game.comboTimeout) clearTimeout(game.comboTimeout);
            
            // æ¸…ç©ºæ´»å‹•æŠ€èƒ½é¡¯ç¤º
            activeSkillsElement.innerHTML = '';
        }
        
        // é–‹å§‹éŠæˆ²
        function startGame() {
            if (game.isRunning) return;
            
            // å¦‚æœé‚„æ²’æœ‰é¸æ“‡æŠ€èƒ½ï¼Œé¡¯ç¤ºæŠ€èƒ½é¸æ“‡ç•Œé¢
            if (!game.selectedSkill) {
                showSkillSelection();
                return;
            }
            
            // æ‡‰ç”¨æŠ€èƒ½æ•ˆæœ
            applySkillEffects();
            
            game.isRunning = true;
            skillSelection.style.display = 'none';
            startGameBtn.textContent = 'éŠæˆ²ä¸­...';
            startGameBtn.disabled = true;
            
            // æ›´æ–°æ´»å‹•æŠ€èƒ½é¡¯ç¤º
            updateActiveSkillsDisplay();
            
            game.timerId = setInterval(() => {
                game.timeLeft--;
                timeElement.textContent = `æ™‚é–“: ${game.timeLeft}ç§’`;
                
                // éš¨æ™‚é–“å¢åŠ æ°´æœç”Ÿæˆé »ç‡
                if (game.fruitInterval > game.minInterval) {
                    game.fruitInterval = Math.max(game.minInterval, 2000 - (60 - game.timeLeft) * 25);
                }
                
                if (game.timeLeft <= 0) {
                    endGame(true);
                }
            }, 1000);
            
            gameLoop();
        }
        
        // æ‡‰ç”¨æŠ€èƒ½æ•ˆæœ
        function applySkillEffects() {
            // æª¢æŸ¥"æ™‚é–“å»¶é•·"æŠ€èƒ½
            const hasExtraTime = game.selectedSkill && game.selectedSkill.effect === "extraTime";
            if (hasExtraTime) {
                game.timeLeft += 15;
                timeElement.textContent = `æ™‚é–“: ${game.timeLeft}ç§’`;
            }
        }
        
        // çµæŸéŠæˆ²
        function endGame(isTimeUp) {
            game.isRunning = false;
            clearInterval(game.timerId);
            cancelAnimationFrame(game.animationId);
            
            finalScoreElement.textContent = game.score;
            
            if (game.score < 0) {
                gameOverTitle.textContent = 'éŠæˆ²çµæŸ (è² åˆ†)';
                gameOverTitle.style.color = '#ff4d6d';
            } else if (isTimeUp) {
                gameOverTitle.textContent = 'æ™‚é–“åˆ°!';
                gameOverTitle.style.color = '#5a9cff';
            } else {
                gameOverTitle.textContent = 'éŠæˆ²çµæŸ';
                gameOverTitle.style.color = '#ff6b8b';
            }
            
            gameOverScreen.style.display = 'flex';
            startGameBtn.textContent = 'é–‹å§‹éŠæˆ²';
            startGameBtn.disabled = false;
        }
        
        // éŠæˆ²ä¸»å¾ªç’°
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç¹ªè£½ç¶²æ ¼èƒŒæ™¯
            drawGridBackground();
            
            // ç”Ÿæˆæ–°æ°´æœ
            if (game.isRunning) {
                const currentTime = Date.now();
                if (currentTime - game.lastFruitTime > game.fruitInterval) {
                    // åˆå§‹éšæ®µç”Ÿæˆ1-2å€‹æ°´æœï¼Œå¾ŒæœŸé€æ¼¸å¢åŠ 
                    const baseCount = Math.floor((60 - game.timeLeft) / 20) + 1;
                    const fruitCount = Math.min(4, baseCount);
                    
                    for (let i = 0; i < fruitCount; i++) {
                        setTimeout(() => {
                            if (game.isRunning) {
                                game.fruits.push(new Fruit());
                                fruitCountElement.textContent = `æ°´æœ: ${game.fruits.length}`;
                            }
                        }, i * 300);
                    }
                    
                    game.lastFruitTime = currentTime;
                }
                
                // ç”Ÿæˆç‚¸å½ˆï¼ˆç•¶åˆ†æ•¸é”åˆ°60åˆ†ä»¥ä¸Šæ™‚ï¼‰
                if (game.score >= 60 && currentTime - game.lastBombTime > game.bombInterval) {
                    game.bombs.push(new Bomb());
                    game.lastBombTime = currentTime;
                }
            }
            
            // æ›´æ–°å’Œç¹ªè£½æ°´æœ
            for (let i = game.fruits.length - 1; i >= 0; i--) {
                const fruit = game.fruits[i];
                const shouldRemove = fruit.update();
                
                if (shouldRemove) {
                    game.fruits.splice(i, 1);
                    fruitCountElement.textContent = `æ°´æœ: ${game.fruits.length}`;
                } else {
                    fruit.draw();
                }
            }
            
            // æ›´æ–°å’Œç¹ªè£½ç‚¸å½ˆ
            for (let i = game.bombs.length - 1; i >= 0; i--) {
                const bomb = game.bombs[i];
                const shouldRemove = bomb.update();
                
                if (shouldRemove) {
                    game.bombs.splice(i, 1);
                } else {
                    bomb.draw();
                }
            }
            
            // æ›´æ–°å’Œç¹ªè£½åˆ‡å‰²ç·š
            for (let i = game.cutLines.length - 1; i >= 0; i--) {
                const line = game.cutLines[i];
                line.life--;
                
                if (line.life <= 0) {
                    game.cutLines.splice(i, 1);
                } else {
                    drawCutLine(line);
                }
            }
            
            if (game.isRunning) {
                game.animationId = requestAnimationFrame(gameLoop);
            }
        }
        
        // ç¹ªè£½åˆ‡å‰²ç·š
        function drawCutLine(line) {
            const gradient = ctx.createLinearGradient(line.x1, line.y1, line.x2, line.y2);
            gradient.addColorStop(0, line.color + 'FF');
            gradient.addColorStop(1, line.color + '00');
            
            ctx.strokeStyle = gradient;
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.globalAlpha = line.life / 30;
            
            ctx.beginPath();
            ctx.moveTo(line.x1, line.y1);
            ctx.lineTo(line.x2, line.y2);
            ctx.stroke();
            
            ctx.globalAlpha = 1.0;
        }
        
        // åˆ‡å‰²ç‰©é«”
        function sliceObject(x1, y1, x2, y2) {
            if (!game.isRunning) return;
            
            let slicedAny = false;
            
            // æª¢æŸ¥æ˜¯å¦åˆ‡å‰²åˆ°æ°´æœ
            for (let i = 0; i < game.fruits.length; i++) {
                const fruit = game.fruits[i];
                
                if (lineIntersectsCircle(x1, y1, x2, y2, fruit.x, fruit.y, fruit.radius)) {
                    if (fruit.slice()) {
                        slicedAny = true;
                        
                        // æª¢æŸ¥åˆ†æ•¸æ˜¯å¦è®Šè² 
                        if (game.score < 0) {
                            endGame(false);
                            return;
                        }
                    }
                }
            }
            
            // æª¢æŸ¥æ˜¯å¦åˆ‡å‰²åˆ°ç‚¸å½ˆ
            for (let i = 0; i < game.bombs.length; i++) {
                const bomb = game.bombs[i];
                
                if (lineIntersectsCircle(x1, y1, x2, y2, bomb.x, bomb.y, bomb.radius)) {
                    if (bomb.explode()) {
                        slicedAny = true;
                        // ä¸é‡ç½®é€£æ“Š
                        
                        // æª¢æŸ¥åˆ†æ•¸æ˜¯å¦è®Šè² 
                        if (game.score < 0) {
                            endGame(false);
                            return;
                        }
                    }
                }
            }
            
            // æ·»åŠ åˆ‡å‰²ç·šæ•ˆæœ
            if (slicedAny || Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2) > 10) {
                const colorIndex = Math.floor(Math.random() * colors.length);
                game.cutLines.push({
                    x1: x1,
                    y1: y1,
                    x2: x2,
                    y2: y2,
                    color: colors[colorIndex],
                    life: 30
                });
            }
        }
        
        // æª¢æŸ¥ç·šæ®µèˆ‡åœ“æ˜¯å¦ç›¸äº¤
        function lineIntersectsCircle(x1, y1, x2, y2, cx, cy, r) {
            // ç°¡åŒ–æª¢æŸ¥ï¼šæª¢æŸ¥ç·šæ®µä¸­é»åˆ°åœ“å¿ƒçš„è·é›¢
            const mx = (x1 + x2) / 2;
            const my = (y1 + y2) / 2;
            const distance = Math.sqrt((mx - cx) ** 2 + (my - cy) ** 2);
            
            return distance < r + 10;
        }
        
        // äº‹ä»¶ç›£è½å™¨
        startGameBtn.addEventListener('click', () => {
            if (!game.selectedSkill) {
                showSkillSelection();
            } else {
                startGame();
            }
        });
        
        selectSkillBtn.addEventListener('click', () => {
            if (game.selectedSkill) {
                startGame();
            } else {
                alert('è«‹é¸æ“‡ä¸€å€‹æŠ€èƒ½ï¼');
            }
        });
        
        restartBtn.addEventListener('click', () => {
            initGame();
            showSkillSelection();
        });
        
        // é¼ æ¨™äº‹ä»¶
        let isMouseDown = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        
        canvas.addEventListener('mousedown', (e) => {
            isMouseDown = true;
            const rect = canvas.getBoundingClientRect();
            lastMouseX = e.clientX - rect.left;
            lastMouseY = e.clientY - rect.top;
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (!isMouseDown) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            sliceObject(lastMouseX, lastMouseY, x, y);
            
            lastMouseX = x;
            lastMouseY = y;
        });
        
        canvas.addEventListener('mouseup', () => {
            isMouseDown = false;
        });
        
        // è§¸æ‘¸äº‹ä»¶
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            lastMouseX = touch.clientX - rect.left;
            lastMouseY = touch.clientY - rect.top;
            isMouseDown = true;
        });
        
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!isMouseDown) return;
            
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            sliceObject(lastMouseX, lastMouseY, x, y);
            
            lastMouseX = x;
            lastMouseY = y;
        });
        
        canvas.addEventListener('touchend', () => {
            isMouseDown = false;
        });
        
        // çª—å£å¤§å°èª¿æ•´
        window.addEventListener('resize', () => {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            // é‡æ–°è¨ˆç®—ç¬¬9æ ¼é«˜åº¦
            gridHeight = canvas.height / GRID_ROWS;
            NINTH_ROW_HEIGHT = gridHeight * 3;
        });
        
        // åˆå§‹åŒ–éŠæˆ²
        initGame();
        
        // ç¹ªè£½åˆå§‹ç•«é¢
        drawGridBackground();
        ctx.fillStyle = '#ff6b8b';
        ctx.font = '28px Arial Rounded MT Bold';
        ctx.textAlign = 'center';
        ctx.fillText('åˆ‡å§æ°´æœ', canvas.width / 2, canvas.height / 2 - 30);
        ctx.fillStyle = '#666';
        ctx.font = '16px Arial';
        ctx.fillText('é»æ“Šå·¦ä¸‹è§’é–‹å§‹éŠæˆ²æŒ‰éˆ•', canvas.width / 2, canvas.height / 2 + 20);
    </script>
</body>
</html>