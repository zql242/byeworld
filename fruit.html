<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ‡æ°´æœæ¸¸æˆ - é«˜çº§ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            user-select: none;
        }
        
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(to bottom, #1a1a2e, #16213e, #0f3460);
            color: #fff;
            overflow: hidden;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            z-index: 10;
            width: 100%;
            max-width: 900px;
        }
        
        h1 {
            font-size: 3.2rem;
            background: linear-gradient(to right, #ff9966, #ff5e62, #00cc66, #3399ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(255, 94, 98, 0.5);
            margin-bottom: 10px;
            letter-spacing: 2px;
        }
        
        .subtitle {
            color: #a0e7ff;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        
        .game-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            height: 600px;
            margin-bottom: 20px;
        }
        
        #game-canvas {
            background-color: rgba(13, 25, 48, 0.9);
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 150, 255, 0.4);
            border: 4px solid #1e6fd9;
            display: block;
            width: 100%;
            height: 100%;
        }
        
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }
        
        .stats-bar {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            font-size: 1.4rem;
            font-weight: bold;
        }
        
        .score-container, .combo-container, .lives-container, .time-container {
            background-color: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            min-width: 120px;
        }
        
        .score-value {
            color: #ffcc00;
            font-size: 2.2rem;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.7);
        }
        
        .combo-value {
            color: #ff66cc;
            font-size: 2rem;
            text-shadow: 0 0 10px rgba(255, 102, 204, 0.7);
        }
        
        .lives-value {
            color: #00ff9d;
            font-size: 2rem;
            text-shadow: 0 0 10px rgba(0, 255, 157, 0.7);
        }
        
        .time-value {
            color: #3399ff;
            font-size: 2rem;
            text-shadow: 0 0 10px rgba(51, 153, 255, 0.7);
        }
        
        .powerup-indicator {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 10px;
        }
        
        .powerup-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 0 10px currentColor;
        }
        
        .game-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            z-index: 10;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            min-width: 150px;
        }
        
        .btn:active {
            transform: translateY(3px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .btn-start {
            background: linear-gradient(to right, #00cc66, #00b359);
            color: white;
        }
        
        .btn-pause {
            background: linear-gradient(to right, #ff9900, #e68a00);
            color: white;
        }
        
        .btn-reset {
            background: linear-gradient(to right, #ff3366, #e62e5c);
            color: white;
        }
        
        .instructions {
            background-color: rgba(13, 25, 48, 0.8);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            max-width: 900px;
            border: 2px solid #1e6fd9;
            box-shadow: 0 0 20px rgba(0, 150, 255, 0.3);
            z-index: 10;
        }
        
        .instructions h3 {
            color: #ff9966;
            margin-bottom: 15px;
            font-size: 1.8rem;
            text-align: center;
        }
        
        .fruit-types {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .fruit-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100px;
        }
        
        .fruit-demo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-bottom: 8px;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
        }
        
        .fruit-name {
            font-size: 1rem;
            color: #a0e7ff;
            text-align: center;
        }
        
        .fruit-score {
            font-size: 0.9rem;
            color: #ffcc00;
            font-weight: bold;
        }
        
        .game-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            font-weight: bold;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            z-index: 10;
            text-shadow: 0 0 20px currentColor;
        }
        
        .combo-popup {
            position: absolute;
            font-size: 3rem;
            font-weight: bold;
            color: #ff66cc;
            text-shadow: 0 0 15px rgba(255, 102, 204, 0.8);
            pointer-events: none;
            opacity: 0;
            z-index: 10;
            animation: comboFloat 1.5s ease-out;
        }
        
        @keyframes comboFloat {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100px); opacity: 0; }
        }
        
        .juice-splash {
            position: absolute;
            width: 100px;
            height: 100px;
            pointer-events: none;
            opacity: 0.8;
            z-index: 2;
        }
        
        .slice-trail {
            position: absolute;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0));
            pointer-events: none;
            z-index: 3;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
        }
        
        .life-lost {
            animation: lifeLost 0.5s ease;
        }
        
        @keyframes lifeLost {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); background-color: #ff3366; }
            100% { transform: scale(1); }
        }
        
        .powerup-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 4;
            opacity: 0;
        }
        
        @media (max-width: 768px) {
            .game-container {
                height: 500px;
            }
            
            h1 {
                font-size: 2.5rem;
            }
            
            .stats-bar {
                font-size: 1.1rem;
                padding: 15px;
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
            
            .score-value, .combo-value, .lives-value, .time-value {
                font-size: 1.8rem;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 1rem;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>åˆ‡æ°´æœå¤§å¸ˆ</h1>
        <p class="subtitle">è¿å‡»ï¼é“å…·ï¼ä¸‰æ¬¡æœºä¼šï¼ä½ èƒ½å¾—å¤šå°‘åˆ†ï¼Ÿ</p>
    </div>
    
    <div class="game-container">
        <canvas id="game-canvas"></canvas>
        
        <div class="ui-overlay">
            <div class="stats-bar">
                <div class="score-container">
                    <div>åˆ†æ•°</div>
                    <div class="score-value" id="score">0</div>
                </div>
                
                <div class="combo-container">
                    <div>è¿å‡»</div>
                    <div class="combo-value" id="combo">x1</div>
                </div>
                
                <div class="lives-container">
                    <div>ç”Ÿå‘½</div>
                    <div class="lives-value" id="lives">3</div>
                </div>
                
                <div class="time-container">
                    <div>æ—¶é—´</div>
                    <div class="time-value" id="time">60</div>
                </div>
            </div>
            
            <div class="powerup-indicator" id="powerup-indicator">
                <!-- é“å…·å›¾æ ‡å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="game-message" id="game-message"></div>
    </div>
    
    <div class="game-buttons">
        <button class="btn btn-start" id="start-btn">å¼€å§‹æ¸¸æˆ</button>
        <button class="btn btn-pause" id="pause-btn">æš‚åœ</button>
        <button class="btn btn-reset" id="reset-btn">é‡æ–°å¼€å§‹</button>
    </div>
    
    <div class="instructions">
        <h3>æ¸¸æˆè¯´æ˜</h3>
        
        <div class="fruit-types">
            <div class="fruit-item">
                <div class="fruit-demo" style="background: radial-gradient(circle at 30% 30%, #ff9966, #ff5e62);">10</div>
                <div class="fruit-name">è¥¿ç“œ</div>
                <div class="fruit-score">+10åˆ†</div>
            </div>
            <div class="fruit-item">
                <div class="fruit-demo" style="background: radial-gradient(circle at 30% 30%, #ffcc00, #ff9900);">15</div>
                <div class="fruit-name">æ©™å­</div>
                <div class="fruit-score">+15åˆ†</div>
            </div>
            <div class="fruit-item">
                <div class="fruit-demo" style="background: radial-gradient(circle at 30% 30%, #ff66cc, #ff3399);">20</div>
                <div class="fruit-name">è‰è“</div>
                <div class="fruit-score">+20åˆ†</div>
            </div>
            <div class="fruit-item">
                <div class="fruit-demo" style="background: radial-gradient(circle at 30% 30%, #333333, #000000); color: white;">ğŸ’£</div>
                <div class="fruit-name">ç‚¸å¼¹</div>
                <div class="fruit-score">-1ç”Ÿå‘½</div>
            </div>
            <div class="fruit-item">
                <div class="fruit-demo" style="background: radial-gradient(circle at 30% 30%, #3399ff, #1e6fd9); color: white;">â„ï¸</div>
                <div class="fruit-name">å†°å†»</div>
                <div class="fruit-score">å†»ç»“æ—¶é—´</div>
            </div>
            <div class="fruit-item">
                <div class="fruit-demo" style="background: radial-gradient(circle at 30% 30%, #ffcc00, #ff9900); color: white;">2Ã—</div>
                <div class="fruit-name">åŒå€</div>
                <div class="fruit-score">åˆ†æ•°ç¿»å€</div>
            </div>
            <div class="fruit-item">
                <div class="fruit-demo" style="background: radial-gradient(circle at 30% 30%, #00cc66, #00994d); color: white;">+15s</div>
                <div class="fruit-name">æ—¶é—´+</div>
                <div class="fruit-score">å¢åŠ æ—¶é—´</div>
            </div>
            <div class="fruit-item">
                <div class="fruit-demo" style="background: radial-gradient(circle at 30% 30%, #ff3366, #cc0044); color: white;">ğŸ’¥</div>
                <div class="fruit-name">å…¨å±çˆ†ç‚¸</div>
                <div class="fruit-score">æ¸…é™¤æ°´æœ</div>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <p><strong>æ¸¸æˆè§„åˆ™ï¼š</strong></p>
            <p>1. åˆ‡æ°´æœå¾—åˆ†ï¼Œåˆ‡ç‚¸å¼¹æ‰£1ç”Ÿå‘½ï¼ˆåˆå§‹3ç”Ÿå‘½ï¼‰</p>
            <p>2. è¿ç»­åˆ‡æ°´æœå¢åŠ è¿å‡»å€æ•°ï¼ˆæœ€é«˜10å€ï¼‰</p>
            <p>3. åˆ‡ç‰¹æ®Šé“å…·è·å¾—å¼ºåŠ›æ•ˆæœ</p>
            <p>4. æ¸¸æˆé€Ÿåº¦ä¼šéšæ—¶é—´é€æ¸åŠ å¿«</p>
            <p>5. ç”Ÿå‘½ä¸º0æˆ–æ—¶é—´åˆ°æ¸¸æˆç»“æŸ</p>
        </div>
    </div>

    <script>
        // æ¸¸æˆä¸»å˜é‡
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        
        // è®¾ç½®ç”»å¸ƒå°ºå¯¸
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        
        // æ¸¸æˆçŠ¶æ€
        let gameRunning = false;
        let gamePaused = false;
        let gameOver = false;
        let score = 0;
        let combo = 1;
        let comboTime = 0;
        let lives = 3;
        let gameTime = 60; // æ¸¸æˆæ—¶é—´ï¼ˆç§’ï¼‰
        let fruits = [];
        let splashes = [];
        let trails = [];
        let powerups = [];
        let activePowerups = {};
        let lastTime = 0;
        let animationId = null;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let gameSpeed = 1.0; // æ¸¸æˆé€Ÿåº¦å› å­ï¼ˆ1.0ä¸ºæ­£å¸¸ï¼‰
        let fruitSpawnRate = 1000; // æ°´æœç”Ÿæˆé—´éš”ï¼ˆæ¯«ç§’ï¼‰
        let bombChance = 0.1; // ç‚¸å¼¹ç”Ÿæˆæ¦‚ç‡
        let gameStartTime = 0;
        
        // æ°´æœç±»å‹é…ç½®
        const fruitTypes = [
            { name: "è¥¿ç“œ", color1: "#ff9966", color2: "#ff5e62", score: 10, radius: 35, symbol: "10" },
            { name: "æ©™å­", color1: "#ffcc00", color2: "#ff9900", score: 15, radius: 30, symbol: "15" },
            { name: "è‰è“", color1: "#ff66cc", color2: "#ff3399", score: 20, radius: 25, symbol: "20" },
            { name: "é’è‹¹æœ", color1: "#00cc66", color2: "#00994d", score: 25, radius: 28, symbol: "25" },
            { name: "è‘¡è„", color1: "#9966ff", color2: "#6600cc", score: 30, radius: 20, symbol: "30" }
        ];
        
        // ç‚¸å¼¹é…ç½®
        const bombType = { 
            name: "ç‚¸å¼¹", 
            color1: "#333333", 
            color2: "#000000", 
            score: 0, 
            radius: 30, 
            isBomb: true, 
            symbol: "ğŸ’£" 
        };
        
        // é“å…·ç±»å‹é…ç½®
        const powerupTypes = [
            { 
                name: "å†°å†»", 
                color1: "#3399ff", 
                color2: "#1e6fd9", 
                symbol: "â„ï¸", 
                radius: 25,
                type: "freeze",
                duration: 3, // ç§’
                effect: function() {
                    // å‡æ…¢æ‰€æœ‰æ°´æœé€Ÿåº¦
                    fruits.forEach(fruit => {
                        fruit.vx *= 0.3;
                        fruit.vy *= 0.3;
                    });
                    showMessage("æ—¶é—´å†»ç»“ï¼", "#3399ff");
                }
            },
            { 
                name: "åŒå€åˆ†æ•°", 
                color1: "#ffcc00", 
                color2: "#ff9900", 
                symbol: "2Ã—", 
                radius: 25,
                type: "doubleScore",
                duration: 30, // ç§’
                effect: function() {
                    showMessage("åŒå€åˆ†æ•°ï¼", "#ffcc00");
                }
            },
            { 
                name: "æ—¶é—´å»¶é•¿", 
                color1: "#00cc66", 
                color2: "#00994d", 
                symbol: "+15s", 
                radius: 25,
                type: "extraTime",
                duration: 0,
                effect: function() {
                    gameTime += 15;
                    showMessage("æ—¶é—´+15ç§’ï¼", "#00cc66");
                }
            },
            { 
                name: "å…¨å±çˆ†ç‚¸", 
                color1: "#ff3366", 
                color2: "#cc0044", 
                symbol: "ğŸ’¥", 
                radius: 25,
                type: "screenClear",
                duration: 0,
                effect: function() {
                    // æ¸…é™¤æ‰€æœ‰æ°´æœï¼ˆé™¤äº†ç‚¸å¼¹ï¼‰
                    fruits = fruits.filter(fruit => fruit.type.isBomb);
                    showMessage("å…¨å±çˆ†ç‚¸ï¼", "#ff3366");
                }
            },
            { 
                name: "æŠ¤ç›¾", 
                color1: "#9966ff", 
                color2: "#6600cc", 
                symbol: "ğŸ›¡ï¸", 
                radius: 25,
                type: "shield",
                duration: 30, // ç§’
                effect: function() {
                    showMessage("æŠ¤ç›¾æ¿€æ´»ï¼", "#9966ff");
                }
            }
        ];
        
        // DOMå…ƒç´ 
        const scoreElement = document.getElementById('score');
        const comboElement = document.getElementById('combo');
        const livesElement = document.getElementById('lives');
        const timeElement = document.getElementById('time');
        const gameMessageElement = document.getElementById('game-message');
        const powerupIndicatorElement = document.getElementById('powerup-indicator');
        const startButton = document.getElementById('start-btn');
        const pauseButton = document.getElementById('pause-btn');
        const resetButton = document.getElementById('reset-btn');
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameRunning = true;
            gamePaused = false;
            gameOver = false;
            score = 0;
            combo = 1;
            comboTime = 0;
            lives = 3;
            gameTime = 60;
            fruits = [];
            splashes = [];
            trails = [];
            powerups = [];
            activePowerups = {};
            gameSpeed = 1.0;
            fruitSpawnRate = 1000;
            bombChance = 0.1;
            gameStartTime = Date.now();
            
            // æ›´æ–°UI
            updateUI();
            updatePowerupIndicator();
            gameMessageElement.textContent = "";
            gameMessageElement.style.opacity = 0;
            
            // å¼€å§‹æ¸¸æˆå¾ªç¯
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            lastTime = performance.now();
            animationId = requestAnimationFrame(gameLoop);
            
            // åˆå§‹ç”Ÿæˆä¸€äº›æ°´æœï¼ˆé€Ÿåº¦è¾ƒæ…¢ï¼‰
            for (let i = 0; i < 3; i++) {
                setTimeout(() => generateFruit(), i * 800);
            }
            
            // å¼€å§‹æ¸¸æˆè®¡æ—¶å’Œæ°´æœç”Ÿæˆ
            startGameTimer();
            startFruitSpawner();
        }
        
        // ç”Ÿæˆæ°´æœ
        function generateFruit() {
            if (!gameRunning || gamePaused || gameOver) return;
            
            // æ ¹æ®æ¸¸æˆè¿›åº¦è°ƒæ•´éš¾åº¦
            const elapsedMinutes = (Date.now() - gameStartTime) / 60000;
            gameSpeed = 1.0 + elapsedMinutes * 0.5; // æ¯åˆ†é’Ÿå¢åŠ 50%é€Ÿåº¦
            bombChance = 0.1 + Math.min(elapsedMinutes * 0.05, 0.3); // æœ€é«˜30%ç‚¸å¼¹æ¦‚ç‡
            
            // éšæœºå†³å®šç”Ÿæˆç±»å‹
            let type;
            const rand = Math.random();
            
            // 10%æ¦‚ç‡ç”Ÿæˆé“å…·
            if (rand < 0.1) {
                type = powerupTypes[Math.floor(Math.random() * powerupTypes.length)];
                type.isPowerup = true;
            }
            // ç‚¸å¼¹æ¦‚ç‡
            else if (rand < 0.1 + bombChance) {
                type = bombType;
            }
            // æ°´æœ
            else {
                type = fruitTypes[Math.floor(Math.random() * fruitTypes.length)];
            }
            
            // éšæœºç”Ÿæˆä½ç½®ï¼ˆä»åº•éƒ¨å¼¹å‡ºï¼‰
            const x = Math.random() * (canvas.width - 100) + 50;
            const y = canvas.height + type.radius;
            
            // éšæœºç”Ÿæˆé€Ÿåº¦ï¼ˆå—æ¸¸æˆé€Ÿåº¦å½±å“ï¼‰
            const baseSpeed = 8 + (gameSpeed - 1.0) * 4; // é€Ÿåº¦éšæ¸¸æˆè¿›è¡Œå¢åŠ 
            const vx = (Math.random() - 0.5) * baseSpeed;
            const vy = - (Math.random() * 8 + 6 + (gameSpeed - 1.0) * 3);
            
            // éšæœºç”Ÿæˆæ—‹è½¬
            const rotation = Math.random() * Math.PI * 2;
            const rotationSpeed = (Math.random() - 0.5) * 0.1;
            
            // æ·»åŠ åˆ°æ•°ç»„
            const item = {
                x, y,
                vx, vy,
                rotation, rotationSpeed,
                type,
                radius: type.radius,
                sliced: false,
                sliceTime: 0
            };
            
            if (type.isPowerup) {
                powerups.push(item);
            } else {
                fruits.push(item);
            }
            
            // ç»§ç»­ç”Ÿæˆæ°´æœ
            if (gameRunning && fruits.length + powerups.length < 20) {
                const delay = Math.max(200, 1000 / gameSpeed); // æœ€å°200msé—´éš”
                setTimeout(generateFruit, delay);
            }
        }
        
        // å¼€å§‹æ°´æœç”Ÿæˆå™¨
        function startFruitSpawner() {
            const spawner = setInterval(() => {
                if (!gameRunning || gamePaused || gameOver) {
                    clearInterval(spawner);
                    return;
                }
                generateFruit();
            }, fruitSpawnRate);
        }
        
        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop(currentTime) {
            const deltaTime = (currentTime - lastTime) / 1000; // è½¬æ¢ä¸ºç§’
            lastTime = currentTime;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            drawBackground();
            
            // æ›´æ–°å’Œç»˜åˆ¶é“å…·
            updatePowerups(deltaTime);
            
            // æ›´æ–°å’Œç»˜åˆ¶æœæ±é£æº…
            updateSplashes(deltaTime);
            
            // æ›´æ–°å’Œç»˜åˆ¶è½¨è¿¹
            updateTrails(deltaTime);
            
            // æ›´æ–°å’Œç»˜åˆ¶æ°´æœ
            updateFruits(deltaTime);
            
            // æ›´æ–°è¿å‡»æ—¶é—´
            if (combo > 1) {
                comboTime -= deltaTime;
                if (comboTime <= 0) {
                    combo = 1;
                    updateUI();
                }
            }
            
            // æ›´æ–°æ¿€æ´»çš„é“å…·æ•ˆæœ
            updateActivePowerups(deltaTime);
            
            // ç»˜åˆ¶é“å…·æ•ˆæœ
            drawPowerupEffects();
            
            // ç»§ç»­æ¸¸æˆå¾ªç¯
            if (gameRunning && !gamePaused && !gameOver) {
                animationId = requestAnimationFrame(gameLoop);
            }
        }
        
        // ç»˜åˆ¶èƒŒæ™¯
        function drawBackground() {
            // èƒŒæ™¯æ¸å˜
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, "#0a1630");
            gradient.addColorStop(1, "#0a0a1a");
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç½‘æ ¼æ•ˆæœ
            ctx.strokeStyle = "rgba(100, 150, 255, 0.05)";
            ctx.lineWidth = 1;
            
            // å‚ç›´çº¿
            for (let x = 0; x < canvas.width; x += 50) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            // æ°´å¹³çº¿
            for (let y = 0; y < canvas.height; y += 50) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // åº•éƒ¨é˜´å½±
            const shadowGradient = ctx.createLinearGradient(0, canvas.height - 100, 0, canvas.height);
            shadowGradient.addColorStop(0, "rgba(0, 0, 0, 0)");
            shadowGradient.addColorStop(1, "rgba(0, 0, 0, 0.5)");
            ctx.fillStyle = shadowGradient;
            ctx.fillRect(0, canvas.height - 100, canvas.width, 100);
            
            // ç»˜åˆ¶å½“å‰æ¸¸æˆé€Ÿåº¦æŒ‡ç¤º
            ctx.fillStyle = "rgba(255, 255, 255, 0.1)";
            ctx.font = "bold 16px Arial";
            ctx.textAlign = "right";
            ctx.fillText(`é€Ÿåº¦: x${gameSpeed.toFixed(1)}`, canvas.width - 20, 30);
        }
        
        // æ›´æ–°æ°´æœçŠ¶æ€
        function updateFruits(deltaTime) {
            for (let i = fruits.length - 1; i >= 0; i--) {
                const fruit = fruits[i];
                
                // åº”ç”¨å†°å†»æ•ˆæœ
                let speedMultiplier = 1.0;
                if (activePowerups.freeze) {
                    speedMultiplier = 0.3;
                }
                
                // æ›´æ–°ä½ç½®
                fruit.x += fruit.vx * speedMultiplier;
                fruit.y += fruit.vy * speedMultiplier;
                fruit.vy += 0.5 * speedMultiplier; // é‡åŠ›
                fruit.rotation += fruit.rotationSpeed * speedMultiplier;
                
                // æ›´æ–°åˆ‡ç‰‡æ—¶é—´ï¼ˆå¦‚æœå·²åˆ‡ç‰‡ï¼‰
                if (fruit.sliced) {
                    fruit.sliceTime += deltaTime;
                }
                
                // è¾¹ç•Œæ£€æŸ¥
                if (fruit.x < fruit.radius) {
                    fruit.x = fruit.radius;
                    fruit.vx *= -0.7; // å¼¹æ€§ç¢°æ’
                } else if (fruit.x > canvas.width - fruit.radius) {
                    fruit.x = canvas.width - fruit.radius;
                    fruit.vx *= -0.7;
                }
                
                // å¦‚æœæ°´æœæ‰å‡ºå±å¹•åº•éƒ¨ä¸”æœªåˆ‡ç‰‡ï¼Œå‡å°‘ç”Ÿå‘½å€¼ï¼ˆå¦‚æœä¸æ˜¯ç‚¸å¼¹ï¼‰
                if (fruit.y > canvas.height + 100) {
                    fruits.splice(i, 1);
                    if (!fruit.sliced && !fruit.type.isBomb && gameRunning) {
                        loseLife();
                    }
                    continue;
                }
                
                // ç»˜åˆ¶æ°´æœ
                drawFruit(fruit);
                
                // å¦‚æœåˆ‡ç‰‡æ—¶é—´è¿‡é•¿ï¼Œç§»é™¤æ°´æœ
                if (fruit.sliced && fruit.sliceTime > 2) {
                    fruits.splice(i, 1);
                }
            }
        }
        
        // æ›´æ–°é“å…·çŠ¶æ€
        function updatePowerups(deltaTime) {
            for (let i = powerups.length - 1; i >= 0; i--) {
                const powerup = powerups[i];
                
                // æ›´æ–°ä½ç½®
                powerup.x += powerup.vx;
                powerup.y += powerup.vy;
                powerup.vy += 0.5; // é‡åŠ›
                powerup.rotation += powerup.rotationSpeed;
                
                // è¾¹ç•Œæ£€æŸ¥
                if (powerup.x < powerup.radius) {
                    powerup.x = powerup.radius;
                    powerup.vx *= -0.7;
                } else if (powerup.x > canvas.width - powerup.radius) {
                    powerup.x = canvas.width - powerup.radius;
                    powerup.vx *= -0.7;
                }
                
                // å¦‚æœé“å…·æ‰å‡ºå±å¹•åº•éƒ¨ï¼Œç§»é™¤
                if (powerup.y > canvas.height + 100) {
                    powerups.splice(i, 1);
                    continue;
                }
                
                // ç»˜åˆ¶é“å…·
                drawPowerup(powerup);
            }
        }
        
        // ç»˜åˆ¶æ°´æœ
        function drawFruit(fruit) {
            ctx.save();
            ctx.translate(fruit.x, fruit.y);
            ctx.rotate(fruit.rotation);
            
            // ç»˜åˆ¶æ°´æœä¸»ä½“
            const gradient = ctx.createRadialGradient(
                -fruit.radius/3, -fruit.radius/3, 1,
                0, 0, fruit.radius
            );
            gradient.addColorStop(0, fruit.type.color1);
            gradient.addColorStop(1, fruit.type.color2);
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(0, 0, fruit.radius, 0, Math.PI * 2);
            ctx.fill();
            
            // æ°´æœé«˜å…‰
            ctx.fillStyle = "rgba(255, 255, 255, 0.2)";
            ctx.beginPath();
            ctx.arc(-fruit.radius/3, -fruit.radius/3, fruit.radius/3, 0, Math.PI * 2);
            ctx.fill();
            
            // å¦‚æœæ˜¯ç‚¸å¼¹ï¼Œç»˜åˆ¶å¼•ä¿¡
            if (fruit.type.isBomb) {
                // ç‚¸å¼¹å¼•ä¿¡
                ctx.fillStyle = "#ff6600";
                ctx.fillRect(-5, -fruit.radius - 10, 10, 15);
                
                // å¼•ä¿¡ç«èŠ±
                ctx.fillStyle = "#ffcc00";
                ctx.beginPath();
                ctx.arc(0, -fruit.radius - 15, 5, 0, Math.PI * 2);
                ctx.fill();
                
                // ç‚¸å¼¹å±é™©æ ‡å¿—
                ctx.fillStyle = "#ff0000";
                ctx.font = "bold 24px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText("ğŸ’£", 0, 0);
            } else {
                // æ°´æœæ•°å­—
                ctx.fillStyle = "white";
                ctx.font = `bold ${fruit.radius}px Arial`;
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(fruit.type.symbol, 0, 0);
            }
            
            // å¦‚æœæ°´æœè¢«åˆ‡ç‰‡ï¼Œç»˜åˆ¶åˆ‡ç‰‡æ•ˆæœ
            if (fruit.sliced) {
                ctx.fillStyle = fruit.type.color1;
                // å·¦åŠéƒ¨åˆ†
                ctx.beginPath();
                ctx.arc(-fruit.radius/2, 0, fruit.radius/2, 0, Math.PI * 2);
                ctx.fill();
                
                // å³åŠéƒ¨åˆ†
                ctx.beginPath();
                ctx.arc(fruit.radius/2, 0, fruit.radius/2, 0, Math.PI * 2);
                ctx.fill();
                
                // æœæ±å†…éƒ¨
                ctx.fillStyle = fruit.type.color2;
                ctx.beginPath();
                ctx.arc(-fruit.radius/2, 0, fruit.radius/4, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(fruit.radius/2, 0, fruit.radius/4, 0, Math.PI * 2);
                ctx.fill();
            }
            
            ctx.restore();
        }
        
        // ç»˜åˆ¶é“å…·
        function drawPowerup(powerup) {
            ctx.save();
            ctx.translate(powerup.x, powerup.y);
            ctx.rotate(powerup.rotation);
            
            // ç»˜åˆ¶é“å…·ä¸»ä½“
            const gradient = ctx.createRadialGradient(
                -powerup.radius/3, -powerup.radius/3, 1,
                0, 0, powerup.radius
            );
            gradient.addColorStop(0, powerup.type.color1);
            gradient.addColorStop(1, powerup.type.color2);
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(0, 0, powerup.radius, 0, Math.PI * 2);
            ctx.fill();
            
            // é“å…·é«˜å…‰
            ctx.fillStyle = "rgba(255, 255, 255, 0.3)";
            ctx.beginPath();
            ctx.arc(-powerup.radius/3, -powerup.radius/3, powerup.radius/3, 0, Math.PI * 2);
            ctx.fill();
            
            // é“å…·å›¾æ ‡
            ctx.fillStyle = "white";
            ctx.font = `bold ${powerup.radius}px Arial`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(powerup.type.symbol, 0, 0);
            
            // å¤–å‘å…‰
            ctx.shadowColor = powerup.type.color1;
            ctx.shadowBlur = 15;
            ctx.strokeStyle = "rgba(255, 255, 255, 0.5)";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(0, 0, powerup.radius, 0, Math.PI * 2);
            ctx.stroke();
            ctx.shadowBlur = 0;
            
            ctx.restore();
        }
        
        // ç»˜åˆ¶é“å…·æ•ˆæœ
        function drawPowerupEffects() {
            // å†°å†»æ•ˆæœ
            if (activePowerups.freeze) {
                ctx.fillStyle = "rgba(51, 153, 255, 0.2)";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // ç»˜åˆ¶å†°æ™¶æ•ˆæœ
                ctx.fillStyle = "rgba(255, 255, 255, 0.3)";
                for (let i = 0; i < 20; i++) {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    const size = Math.random() * 10 + 5;
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // åŒå€åˆ†æ•°æ•ˆæœ
            if (activePowerups.doubleScore) {
                ctx.fillStyle = "rgba(255, 204, 0, 0.1)";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            // æŠ¤ç›¾æ•ˆæœ
            if (activePowerups.shield) {
                ctx.strokeStyle = "rgba(153, 102, 255, 0.5)";
                ctx.lineWidth = 3;
                ctx.setLineDash([10, 5]);
                ctx.strokeRect(10, 10, canvas.width - 20, canvas.height - 20);
                ctx.setLineDash([]);
            }
        }
        
        // æ›´æ–°æ¿€æ´»çš„é“å…·æ•ˆæœ
        function updateActivePowerups(deltaTime) {
            for (const type in activePowerups) {
                if (activePowerups[type].duration > 0) {
                    activePowerups[type].duration -= deltaTime;
                    if (activePowerups[type].duration <= 0) {
                        delete activePowerups[type];
                        updatePowerupIndicator();
                    }
                }
            }
        }
        
        // æ›´æ–°æœæ±é£æº…æ•ˆæœ
        function updateSplashes(deltaTime) {
            for (let i = splashes.length - 1; i >= 0; i--) {
                const splash = splashes[i];
                splash.life -= deltaTime;
                
                if (splash.life <= 0) {
                    splashes.splice(i, 1);
                    continue;
                }
                
                // æ›´æ–°ä½ç½®
                splash.x += splash.vx;
                splash.y += splash.vy;
                splash.vy += 0.2; // é‡åŠ›
                
                // ç»˜åˆ¶æœæ±é£æº…
                ctx.fillStyle = splash.color;
                ctx.globalAlpha = splash.life / splash.maxLife;
                ctx.beginPath();
                ctx.arc(splash.x, splash.y, splash.radius, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.globalAlpha = 1;
        }
        
        // æ›´æ–°è½¨è¿¹æ•ˆæœ
        function updateTrails(deltaTime) {
            for (let i = trails.length - 1; i >= 0; i--) {
                const trail = trails[i];
                trail.life -= deltaTime * 3;
                
                if (trail.life <= 0) {
                    trails.splice(i, 1);
                    continue;
                }
                
                // ç»˜åˆ¶è½¨è¿¹
                ctx.strokeStyle = `rgba(255, 255, 255, ${trail.life})`;
                ctx.lineWidth = trail.width;
                ctx.lineCap = "round";
                ctx.beginPath();
                ctx.moveTo(trail.x1, trail.y1);
                ctx.lineTo(trail.x2, trail.y2);
                ctx.stroke();
            }
        }
        
        // åˆ‡å‰²æ£€æµ‹
        function sliceAt(x, y) {
            if (!gameRunning || gamePaused || gameOver) return false;
            
            let slicedSomething = false;
            
            // æ£€æŸ¥æ°´æœ
            for (let i = fruits.length - 1; i >= 0; i--) {
                const fruit = fruits[i];
                
                // æ£€æŸ¥æ˜¯å¦åˆ‡å‰²åˆ°æ°´æœ
                const distance = Math.sqrt((x - fruit.x) ** 2 + (y - fruit.y) ** 2);
                
                if (distance < fruit.radius && !fruit.sliced) {
                    handleFruitSlice(fruit, i);
                    slicedSomething = true;
                    break;
                }
            }
            
            // æ£€æŸ¥é“å…·
            if (!slicedSomething) {
                for (let i = powerups.length - 1; i >= 0; i--) {
                    const powerup = powerups[i];
                    
                    const distance = Math.sqrt((x - powerup.x) ** 2 + (y - powerup.y) ** 2);
                    
                    if (distance < powerup.radius) {
                        handlePowerupSlice(powerup, i);
                        slicedSomething = true;
                        break;
                    }
                }
            }
            
            // è¿å‡»å¤„ç†
            if (slicedSomething) {
                // å¢åŠ è¿å‡»
                combo = Math.min(combo + 1, 10);
                comboTime = 2; // é‡ç½®è¿å‡»æ—¶é—´
                showComboPopup(x, y, combo);
            } else if (combo > 1) {
                // æ–­è¿é‡ç½®
                combo = 1;
                comboTime = 0;
            }
            
            return slicedSomething;
        }
        
        // å¤„ç†æ°´æœåˆ‡å‰²
        function handleFruitSlice(fruit, index) {
            // æ ‡è®°æ°´æœä¸ºå·²åˆ‡å‰²
            fruit.sliced = true;
            fruit.vx = (Math.random() - 0.5) * 10;
            fruit.vy = -5;
            
            // åˆ›å»ºæœæ±é£æº…æ•ˆæœ
            createSplash(fruit.x, fruit.y, fruit.type.color1);
            
            // å¦‚æœæ˜¯ç‚¸å¼¹ï¼Œå¤„ç†çˆ†ç‚¸
            if (fruit.type.isBomb) {
                // æ£€æŸ¥æ˜¯å¦æœ‰æŠ¤ç›¾
                if (activePowerups.shield) {
                    showMessage("æŠ¤ç›¾æŠµæŒ¡äº†ç‚¸å¼¹ï¼", "#9966ff");
                    delete activePowerups.shield;
                    updatePowerupIndicator();
                } else {
                    handleBombExplosion(fruit.x, fruit.y);
                }
                return;
            }
            
            // è®¡ç®—åˆ†æ•°ï¼ˆè€ƒè™‘è¿å‡»å’ŒåŒå€åˆ†æ•°ï¼‰
            let points = fruit.type.score * combo;
            if (activePowerups.doubleScore) {
                points *= 2;
            }
            score += points;
            
            // æ˜¾ç¤ºåˆ†æ•°è·å¾—
            showScorePopup(fruit.x, fruit.y, points);
            
            // æ£€æŸ¥æˆå°±
            checkAchievements();
            
            updateUI();
        }
        
        // å¤„ç†é“å…·åˆ‡å‰²
        function handlePowerupSlice(powerup, index) {
            // ç§»é™¤é“å…·
            powerups.splice(index, 1);
            
            // åˆ›å»ºç‰¹æ•ˆ
            createSplash(powerup.x, powerup.y, powerup.type.color1);
            
            // æ¿€æ´»é“å…·æ•ˆæœ
            activatePowerup(powerup.type);
            
            updateUI();
        }
        
        // æ¿€æ´»é“å…·
        function activatePowerup(powerupType) {
            // æ‰§è¡Œé“å…·æ•ˆæœ
            powerupType.effect();
            
            // æ·»åŠ åˆ°æ¿€æ´»é“å…·åˆ—è¡¨
            activePowerups[powerupType.type] = {
                type: powerupType.type,
                duration: powerupType.duration,
                startTime: Date.now()
            };
            
            updatePowerupIndicator();
        }
        
        // å¤„ç†ç‚¸å¼¹çˆ†ç‚¸
        function handleBombExplosion(x, y) {
            // å‡å°‘ç”Ÿå‘½å€¼
            loseLife();
            
            // é‡ç½®è¿å‡»
            combo = 1;
            comboTime = 0;
            
            // åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
            for (let i = 0; i < 30; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 8 + 3;
                
                splashes.push({
                    x, y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    radius: Math.random() * 6 + 3,
                    color: "#ff6600",
                    life: 1.5,
                    maxLife: 1.5
                });
            }
            
            // æ˜¾ç¤ºçˆ†ç‚¸æ¶ˆæ¯
            showMessage("ç‚¸å¼¹ï¼", "#ff3366");
            
            // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
            if (lives <= 0) {
                gameOver = true;
                endGame(false);
            }
        }
        
        // å‡å°‘ç”Ÿå‘½
        function loseLife() {
            lives--;
            
            // ç”Ÿå‘½å€¼åŠ¨ç”»
            livesElement.classList.add('life-lost');
            setTimeout(() => {
                livesElement.classList.remove('life-lost');
            }, 500);
            
            updateUI();
        }
        
        // åˆ›å»ºæœæ±é£æº…æ•ˆæœ
        function createSplash(x, y, color) {
            const particleCount = 20;
            
            for (let i = 0; i < particleCount; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 6 + 3;
                
                splashes.push({
                    x, y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    radius: Math.random() * 8 + 4,
                    color: color,
                    life: 1,
                    maxLife: 1
                });
            }
        }
        
        // æ˜¾ç¤ºè¿å‡»å¼¹çª—
        function showComboPopup(x, y, comboValue) {
            const popup = document.createElement('div');
            popup.className = 'combo-popup';
            popup.textContent = `${comboValue}è¿å‡»!`;
            popup.style.left = `${x}px`;
            popup.style.top = `${y}px`;
            
            document.querySelector('.game-container').appendChild(popup);
            
            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.parentNode.removeChild(popup);
                }
            }, 1500);
        }
        
        // æ˜¾ç¤ºåˆ†æ•°å¼¹çª—
        function showScorePopup(x, y, score) {
            const popup = document.createElement('div');
            popup.className = 'combo-popup';
            popup.textContent = `+${score}`;
            popup.style.left = `${x}px`;
            popup.style.top = `${y}px`;
            popup.style.color = '#ffcc00';
            popup.style.fontSize = '2rem';
            
            document.querySelector('.game-container').appendChild(popup);
            
            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.parentNode.removeChild(popup);
                }
            }, 1000);
        }
        
        // æ˜¾ç¤ºæ¸¸æˆæ¶ˆæ¯
        function showMessage(text, color) {
            gameMessageElement.textContent = text;
            gameMessageElement.style.color = color;
            gameMessageElement.style.opacity = 1;
            
            // æ·¡å‡ºæ•ˆæœ
            setTimeout(() => {
                let opacity = 1;
                const fadeOut = setInterval(() => {
                    opacity -= 0.05;
                    gameMessageElement.style.opacity = opacity;
                    
                    if (opacity <= 0) {
                        clearInterval(fadeOut);
                        gameMessageElement.style.opacity = 0;
                    }
                }, 50);
            }, 1000);
        }
        
        // å¼€å§‹æ¸¸æˆè®¡æ—¶å™¨
        function startGameTimer() {
            const timer = setInterval(() => {
                if (!gameRunning || gamePaused || gameOver) {
                    clearInterval(timer);
                    return;
                }
                
                gameTime--;
                timeElement.textContent = gameTime;
                
                // æ—¶é—´åˆ°ï¼Œæ¸¸æˆç»“æŸ
                if (gameTime <= 0) {
                    clearInterval(timer);
                    gameOver = true;
                    endGame(true);
                }
            }, 1000);
        }
        
        // æ£€æŸ¥æˆå°±
        function checkAchievements() {
            // è¿å‡»æˆå°±
            if (combo >= 5) {
                showMessage(`${combo}è¿å‡»ï¼å¤ªæ£’äº†ï¼`, "#ff66cc");
            }
            
            // åˆ†æ•°æˆå°±
            if (score >= 1000 && score < 1100) {
                showMessage("çªç ´1000åˆ†ï¼", "#ffcc00");
            } else if (score >= 2000 && score < 2100) {
                showMessage("çªç ´2000åˆ†ï¼å¤§å¸ˆçº§ï¼", "#00ff9d");
            }
        }
        
        // ç»“æŸæ¸¸æˆ
        function endGame(success) {
            gameRunning = false;
            
            if (success) {
                showMessage(`æ—¶é—´åˆ°ï¼æœ€ç»ˆåˆ†æ•°: ${score}`, "#00ff9d");
            } else {
                showMessage(`æ¸¸æˆç»“æŸï¼æœ€ç»ˆåˆ†æ•°: ${score}`, "#ff3366");
            }
        }
        
        // æ›´æ–°UI
        function updateUI() {
            scoreElement.textContent = score;
            comboElement.textContent = `x${combo}`;
            livesElement.textContent = lives;
            timeElement.textContent = gameTime;
        }
        
        // æ›´æ–°é“å…·æŒ‡ç¤ºå™¨
        function updatePowerupIndicator() {
            powerupIndicatorElement.innerHTML = '';
            
            for (const type in activePowerups) {
                const powerup = activePowerups[type];
                const powerupType = powerupTypes.find(p => p.type === type);
                
                if (powerupType) {
                    const icon = document.createElement('div');
                    icon.className = 'powerup-icon';
                    icon.textContent = powerupType.symbol;
                    icon.style.backgroundColor = powerupType.color1;
                    icon.style.color = 'white';
                    
                    // æ·»åŠ å€’è®¡æ—¶
                    if (powerup.duration > 0) {
                        const time = document.createElement('div');
                        time.style.fontSize = '0.8rem';
                        time.style.marginTop = '5px';
                        time.textContent = Math.ceil(powerup.duration);
                        icon.appendChild(time);
                    }
                    
                    powerupIndicatorElement.appendChild(icon);
                }
            }
        }
        
        // é¼ æ ‡/è§¦æ‘¸äº‹ä»¶å¤„ç†
        function handleStart(x, y) {
            if (!gameRunning || gamePaused || gameOver) return;
            
            isDrawing = true;
            lastX = x;
            lastY = y;
            
            // ç«‹å³åˆ‡å‰²èµ·ç‚¹ä½ç½®
            sliceAt(x, y);
        }
        
        function handleMove(x, y) {
            if (!isDrawing || !gameRunning || gamePaused || gameOver) return;
            
            // åˆ‡å‰²è½¨è¿¹ä¸Šçš„ç‚¹
            const steps = 15;
            for (let i = 0; i < steps; i++) {
                const stepX = lastX + (x - lastX) * (i / steps);
                const stepY = lastY + (y - lastY) * (i / steps);
                sliceAt(stepX, stepY);
            }
            
            // æ·»åŠ è½¨è¿¹æ•ˆæœ
            trails.push({
                x1: lastX, y1: lastY,
                x2: x, y2: y,
                width: 6,
                life: 1
            });
            
            lastX = x;
            lastY = y;
        }
        
        function handleEnd() {
            isDrawing = false;
        }
        
        // äº‹ä»¶ç›‘å¬å™¨è®¾ç½®
        function setupEventListeners() {
            // é¼ æ ‡äº‹ä»¶
            canvas.addEventListener('mousedown', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                handleStart(x, y);
            });
            
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                handleMove(x, y);
            });
            
            canvas.addEventListener('mouseup', handleEnd);
            canvas.addEventListener('mouseleave', handleEnd);
            
            // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches[0];
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                handleStart(x, y);
            });
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches[0];
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                handleMove(x, y);
            });
            
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                handleEnd();
            });
            
            // æŒ‰é’®äº‹ä»¶
            startButton.addEventListener('click', () => {
                if (!gameRunning || gameOver) {
                    initGame();
                    startButton.textContent = "é‡æ–°å¼€å§‹";
                }
            });
            
            pauseButton.addEventListener('click', () => {
                if (!gameRunning) return;
                
                gamePaused = !gamePaused;
                
                if (gamePaused) {
                    pauseButton.textContent = "ç»§ç»­";
                    showMessage("æ¸¸æˆæš‚åœ", "#ff9900");
                } else {
                    pauseButton.textContent = "æš‚åœ";
                    lastTime = performance.now();
                    animationId = requestAnimationFrame(gameLoop);
                }
            });
            
            resetButton.addEventListener('click', () => {
                initGame();
            });
            
            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', () => {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
            });
        }
        
        // åˆå§‹åŒ–
        function init() {
            setupEventListeners();
            initGame();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>